<!-- Imports -->
<link rel="import" href="document/countreport/nuxeo-countreport-view-layout.html">
<link rel="import" href="document/countreport/nuxeo-countreport-create-layout.html">
<dom-module id="nuxeo-home">
  <template>
    <style>
      :host {
        display: block;
        @apply(--layout-flex);
        @apply(--layout-vertical);
      }

      .flex-layout {
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: space-between;
      }

      paper-card {
        min-width: 25em;
        width: 49%;
        height: 420px;
      }

      @media (max-width: 1024px) {
        paper-card {
          width: 100%;
        }
      }

      h3 iron-icon {
        width: 1.3em;
        margin-right: 0.4em;
      }

      nuxeo-data-table, nuxeo-tasks-list, nuxeo-tasks-list ::content nuxeo-data-list {
        height: 350px !important;
      }

      .ellipsis {
        text-overflow: ellipsis;
        overflow: hidden;
        white-space: nowrap;
        display: block;
        width: calc(100% - 38px);
      }

      .graph-iron-icon {
        color: #0f9d58;
        --iron-icon-width: 144px;
        --iron-icon-height: 144px;
        margin-top: 50px;
      }

      .graph-flex-layout {
        flex: 1 0 calc(33% - 2em);
        margin: 0 8px 16px;
        text-align: center;
      }

      #button.settings{
        position: absolute;
        top: 8px;
        right: 8px;
      }

      chart-line,
      ::content #canvas.chart-line,
      chart-pie,
      ::content #canvas.chart-pie {
        margin: 25px auto 0 auto;
        width: 100% !important;
        min-width: 30em;
        display: block;
        font-size: .8em;
      }

      #trayReport {
        position: absolute;
        bottom: 32px;
        right: 32px;
        z-index: 10;
      }

      #createReportBtn {
        color: var(--nuxeo-button-primary-text);
        --paper-fab-background: var(--nuxeo-button-primary);
        --paper-fab-keyboard-focus-background: var(--nuxeo-button-primary-focus);
      }

      #container {
        @apply(--layout-vertical);
        @apply(--layout-center);
        @apply(--layout-flex);
        @apply(--layout-center-justified);
        border-radius: 2px;
        border: 1px dashed var(--paper-input-container-color);
        min-height: 64px;
        height: calc(100% - 2px);
      }

      .container {
        overflow: auto;
        flex: 1 1 auto;
        height: 400px;
      }

      .typeSelection {
        overflow-y: auto;
        margin: 1rem 0;
        align-items: center;
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        min-height: 20em;
        justify-content: flex-start;
      }

      .typeSelection paper-button {
        width: var(--nuxeo-document-creation-form-button-width, 128px);
        height: var(--nuxeo-document-creation-form-button-height, 128px);
        box-shadow: none;
        background-color: var(--nuxeo-dialog-buttons-bar);
      }

      .typeSelection paper-button:hover {
        color: var(--nuxeo-link-hover-color);
        filter: brightness(102%);
        -webkit-filter: brightness(102%);
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.3), 0 -3px 0 var(--nuxeo-link-hover-color) inset;
      }

      .typeSelection iron-icon {
        width: var(--nuxeo-document-creation-form-icon-width, 42px);
        height: var(--nuxeo-document-creation-form-icon-height, 42px);
        filter: brightness(1.5);
        -webkit-filter: brightness(1.5);
      }

      .typeSelection span {
        margin-top: 1em;
        word-break: break-word;
      }

      .docTypeButton {
        margin: 4px;
        border: none;
      }

      .buttons {
        @apply(--buttons-bar);
      }

      .heading {
        text-transform: uppercase;
        font-size: 1.1rem;
        padding: 1.7rem 2.5rem;
      }

      .heading iron-icon {
        width: 1.2rem;
        height: 1.2rem;
        margin-right: 8px;
      }

      .editor {
        margin: 0 2rem;
        overflow-y: auto;
        padding: 0 1rem 0 0;
      }

      #document-create {
        margin-bottom: 2.5em;
      }

    </style>

    <nuxeo-page>
      <div class="header">[[i18n('home.dashboard')]]</div>
      <div class="content">
        <section name="dashboard" class="flex-layout">

		  <!--Get the list of Reports-->
		  <nuxeo-page-provider
                               role="widget"
                               id="reportProvider"
                               auto
                               query="select * from Document where ecm:primaryType in ('CountReport', 'ChartBarReport', 'ChartPieReport', 'ChartLineReport', 'TableReport') and ecm:currentLifeCycleState != 'deleted'"
                               params="[[params]]"
                               current-page="{{reports}}">
          </nuxeo-page-provider>

		  <template is="dom-repeat" items="[[reports]]" as="report">
		  	<template is="dom-if" if="[[report.type == 'Count']]">
		  		<nuxeo-countreport-view-layout document="[[report]]"></nuxeo-countreport-view-layout>
		  	</template>
		  </template>


		  <!--End list of Reports-->




          <nuxeo-repository-data
                                 ecm-primary-type="Opportunity"
                                 ecm-lifecycle-state="new"
                                 metrics="sum(opportunity:amount)"
                                 data="{{newAmount}}"
                                 index="[[index]]">
          </nuxeo-repository-data>
          <paper-card class="graph-flex-layout" heading="New Deals" elevation="0" style="width: 33%; height: 210px">
              <h1><strong><span style="font-size: -webkit-xxx-large;">[[_formatCurrency(newAmount)]] €</span></strong></h1>
          </paper-card>


          <nuxeo-repository-data
                                 ecm-primary-type="Opportunity"
                                 ecm-lifecycle-state="ongoing"
                                 metrics="sum(opportunity:amount)"
                                 data="{{ongoingAmount}}"
                                 index="[[index]]">
          </nuxeo-repository-data>
          <paper-card class="graph-flex-layout" heading="Deals in Progress" elevation="0" style="width: 33%; height: 210px">
              <h1><strong><span style="color: #3599DC; font-size: -webkit-xxx-large;">[[_formatCurrency(ongoingAmount)]] €</span></strong></h1>
          </paper-card>


          <nuxeo-repository-data
                                 ecm-primary-type="Opportunity"
                                 ecm-lifecycle-state="won"
                                 metrics="sum(opportunity:amount)"
                                 data="{{wonAmount}}"
                                 index="[[index]]">
          </nuxeo-repository-data>

          <paper-card class="graph-flex-layout" heading="Won Deals" elevation="0" style="width: 33%; height: 210px">
              <h1><strong><span style="color: #43C35E; font-size: -webkit-xxx-large;">[[_formatCurrency(wonAmount)]] €</span></strong></h1>
          </paper-card>


          <!-- Edit graph dynamically -->

          <!-- Number of documents -->
          <nuxeo-repository-data
            ecm-primary-type="[[documentType]]"
            start-date="[[startDate]]"
            end-date="[[_extendEndDate(endDate)]]"
            metrics="cardinality(ecm:uuid)"
            data="{{totalCount}}"
            index="[[index]]">
          </nuxeo-repository-data>
          <paper-card class="graph-flex-layout" heading="{{documentType}}" elevation="0">

            <paper-icon-button class="settings" id="button" icon="icons:settings" on-tap="_toggleGraphDialog"></paper-icon-button>
            <paper-tooltip for="button">Settings</paper-tooltip>

            <iron-icon class="graph-iron-icon" icon="icons:description"></iron-icon>
            <h1>[[totalCount]]</h1>

            <paper-dialog id="dialog" modal on-iron-overlay-closed="_resetPopup" no-auto-focus>
              <!--nuxeo-document id="doc" doc-id="[[document.uid]]"
                          data="{{document}}" response="{{document}}"
                          headers="[[headers]]">
              </nuxeo-document-->
              <h2>Settings</h2>
              <form id="form" is="iron-form">
                <div class="container layout vertical">
                  <div class="row layout horizontal">
                    <div id="document-edit">
                      <paper-input value="{{documentType}}" label="Document Type" type="string" role="widget"></paper-input>
                    </div>
                  </div>
                </div>
                <div class="buttons horizontal end-justified layout">
                  <div class="flex start-justified">
                    <paper-button noink dialog-dismiss>Cancel</paper-button>
                  </div>
                  <paper-button noink class="primary" on-tap="_save">
                    Save
                  </paper-button>
                </div>
              </form>
            </paper-dialog>
          </paper-card>

          <!-- chart-pie -->
          <nuxeo-repository-data start-date="[[startDate]]" end-date="[[endDate]]"
                                 ecm-primary-type="[[documentType]]"
                                 grouped-by="ecm:currentLifeCycleState"
                                 metrics="sum(opportunity:amount)"
                                 data="{{amountCount}}"
                                 index="[[index]]">
          </nuxeo-repository-data>

          <paper-card class="graph-flex-layout" heading="Amount" elevation="0">
            <paper-icon-button class="settings" id="button" icon="icons:settings" on-tap="_toggleGraphDialog"></paper-icon-button>
            <paper-tooltip for="button">Settings</paper-tooltip>
            <div class="card-content">
              <chart-pie values="[[_values(amountCount)]]"
                         labels="[[_labels(amountCount)]]"
                         colors="[[colors]]"
                         options='{ "legend": { "display": true, "position": "bottom", "labels": { "boxWidth": 12 } }, "animation": false }'>
              </chart-pie>
            </div>

            <paper-dialog id="chartDialog" modal on-iron-overlay-closed="_resetPopup" no-auto-focus>
              <!--nuxeo-document id="doc" doc-id="[[document.uid]]"
                          data="{{document}}" response="{{document}}"
                          headers="[[headers]]">
              </nuxeo-document-->
              <h2>Settings</h2>
              <form id="form" is="iron-form">
                <div class="container layout vertical">
                  <div class="row layout horizontal">
                    <div id="document-edit">
                      <paper-input value="{{documentType}}" label="Document Type" type="string" role="widget"></paper-input>
                    </div>
                  </div>
                </div>
                <div class="buttons horizontal end-justified layout">
                  <div class="flex start-justified">
                    <paper-button noink dialog-dismiss>Cancel</paper-button>
                  </div>
                  <paper-button noink class="primary" on-tap="_save">
                    Save
                  </paper-button>
                </div>
              </form>
            </paper-dialog>
          </paper-card>

          <!-- chart-line -->
          <nuxeo-repository-data start-date="[[startDate]]" end-date="[[endDate]]"
                                 ecm-primary-type="[[documentType]]"
                                 with-date-intervals="week"
                                 date-field="dc:created"
                                 data="{{docsCreatedPerWeek}}"
                                 index="[[index]]">
          </nuxeo-repository-data>

          <paper-card heading="{{documentType}}" elevation="0">
            <paper-icon-button class="settings" id="button" icon="icons:settings" on-tap="_toggleGraphDialog"></paper-icon-button>
            <paper-tooltip for="button">Settings</paper-tooltip>
            <div class="card-content">
              <chart-line labels="[[_labels(docsCreatedPerWeek)]]"
                          values="[[_values(docsCreatedPerWeek)]]"
                          options='{ "legend": { "display": false }, "animation": false }'>
              </chart-line>
            </div>
          </paper-card>



          <!-- Top Downloads -->
          <nuxeo-audit-data event-id="download"
                            where='{"extended.downloadReason": "download"}'
                            grouped-by="docUUID"
                            group-limit="10"
                            start-date="[[startDate]]" end-date="[[_extendEndDate(endDate)]]"
                            data="{{downloads}}">
          </nuxeo-audit-data>

          <nuxeo-page-provider auto page-size="10"
            query="[[_downloadsQuery(downloads)]]"
            schemas="dublincore, common"
            current-page="{{downloadedDocs}}">
          </nuxeo-page-provider>

          <paper-card heading="[[i18n('repositoryAnalytics.topDownloads.heading')]]" elevation="0">
            <template is="dom-if" if="[[!_isEmpty(downloads)]]">
              <nuxeo-data-table items="[[downloadedDocs]]">
                <nuxeo-data-table-column name="[[i18n('repositoryAnalytics.topDownloads.file')]]">
                  <template>[[item.title]]</template>
                </nuxeo-data-table-column>
                <nuxeo-data-table-column name="[[i18n('repositoryAnalytics.topDownloads.downloads')]]">
                  <template>[[_numberOfDownloads(item)]]</template>
                </nuxeo-data-table-column>
              </nuxeo-data-table>
            </template>
            <template is="dom-if" if="[[_isEmpty(downloads)]]">
              <div class="message">[[i18n('repositoryAnalytics.noResults')]]</div>
            </template>
          </paper-card>







          <!-- Number of calls per hour -->
          <nuxeo-search-data start-date="[[startDate]]" end-date="[[_extendEndDate(endDate)]]"
                            with-date-intervals="hour"
                            without-extended-bounds
                            date-format="HH"
                            data="{{callsPerHour}}"
                            index="[[index]]">
          </nuxeo-search-data>

          <paper-card heading="[[i18n('searchAnalytics.callsPerHour.heading')]]" elevation="0">
            <chart-bar labels="[[_range(0,23)]]"
                      values="[[_aggregatePerHourOfDay(callsPerHour)]]"
                      series="[[_range(0,23)]]"
                      options='{ "legend": { "display": false }, "animation": false }'>
            </chart-bar>
          </paper-card>







        </section>
      </div>
    </nuxeo-page>


    <div id="trayReport">
      <paper-fab id="createReportBtn" noink="" icon="nuxeo:add" on-tap="_toggleReportCreationDialog"></paper-fab>
       <paper-tooltip for="createReportBtn" position="left">Create Report</paper-tooltip>
    </div>

	<paper-dialog id="reportCreationDialog" modal on-iron-overlay-closed="_resetPopup" no-auto-focus>
    <iron-pages selected="[[stage]]" attr-for-selected="name" class="vertical layout flex">

      <div name="choose" class="vertical layout flex">
        <div class="editor flex container">
          <div name="typeSelection" class="typeSelection">
            <template is="dom-repeat" items="[[reportTypes]]" as="type">
              <paper-button noink="" name$="[[type.type]]" class="docTypeButton vertical layout" on-tap="_selectType" data-args$="[[type]]">
                <iron-icon src="[[_getTypeIcon(type)]]"></iron-icon>
                <span>[[_getTypeLabel(type)]]</span>
              </paper-button>
            </template>
          </div>
        </div>
        <div class="buttons horizontal end-justified layout">
          <div class="flex start-justified">
            <paper-button noink="" dialog-dismiss="" on-tap="_cancel">[[i18n('command.cancel')]]</paper-button>
          </div>
        </div>
      </div>

      <div name="edit" class="vertical layout flex">
        <div class="horizontal layout heading center">
          <iron-icon src="[[_getTypeIcon(selectedDocType)]]"></iron-icon>
          <span>[[_newDocumentLabel(selectedDocType)]]</span>
        </div>
        <div id="editor" class="editor flex container">
          <form is="iron-form" id="form" class="form vertical layout flex">
            <iron-a11y-keys keys="enter" on-keys-pressed="_submitKeyHandler"></iron-a11y-keys>
            <nuxeo-document-layout id="document-create" layout="create" document="[[document]]"></nuxeo-document-layout>
          </form>
        </div>
        <div class="buttons horizontal end-justified layout">
          <div class="flex start-justified">
            <paper-button noink="" dialog-dismiss="" on-tap="_cancel">[[i18n('command.cancel')]]</paper-button>
          </div>
          <paper-button noink="" on-tap="_back">[[i18n('command.back')]]</paper-button>
          <paper-button noink="" class="primary" on-tap="_create" disabled$="[[!canCreate]]">[[i18n('command.create')]]</paper-button>
        </div>
      </div>


    </iron-pages>
  </paper-dialog>
  </template>

  <script>
  Polymer({
    is: 'nuxeo-home',
    behaviors: [Nuxeo.RoutingBehavior, Nuxeo.FormatBehavior, Nuxeo.ChartDataBehavior,Nuxeo.DocumentCreationBehavior],
    properties: {
      documentType: {
        type: String,
        value: "Opportunity"
      },
      index: {
        type: String,
        value: 'nuxeo'
      },
      startDate: String,
      endDate: String,
      hoursBounds: {
        value: {min: 0, max: 23}
      },


      reportTypes: {
      	type: Array
      },


      stage: {
          type: String,
          value: 'choose'
        },

        visible: {
          type: Boolean
        },

        _showTabs: {
          type: Boolean,
          value: true
        },
        selectedTab: {
          type: String,
          value: ''
        },


    },

    listeners: {
      'nx-creation-wizard-hide-tabs': '_hideTabs',
      'nx-creation-wizard-show-tabs': '_displayTabs',
      'nx-document-creation-finished': '_close'
    },


    _hideTabs: function() {
      this._showTabs = false;
    },

    _displayTabs: function() {
      this._showTabs = true;
    },

    _close: function() {
      if (this.$.reportCreationDialog.opened) {
        this.$.reportCreationDialog.toggle();
        this._showTabs = true;
      }
    },


    _navigate: function(e) {
      var detail;
      if (e.detail.item) {
        detail = {
          doc: e.detail.item
        };
        page('/browse' + detail.doc.path);
      } else {
        detail = {
          doc: e.model.item
        };
      }
      this.fire('navigate', detail);
    },

    ready: function() {
      jQuery("#tray").css("display","none");

      this.reportTypes = ['CountReport', 'ChartBarReport', 'ChartPieReport', 'ChartLineReport', 'TableReport'];

      /*this._fetchFavorite().then(function(favorite) {
        this.$.favoritesProvider.params = [favorite.uid];
        this.$.favoritesProvider.page = 1;
        this.$.favoritesProvider.fetch();
      }.bind(this));*/
    },

    _fetchFavorite: function() {
      if (this.favorite) {
        return Promise.resolve(this.favorite);
      } else {
        return this.$.fetchFavOp.execute()
          .then(function(resp) {
          this.favorite = resp;
          return resp;
        }.bind(this));
      }
    },

    _toggleGraphDialog: function(){
      this.$.dialog.toggle();
    },

    /*_validate: function() {
        var valid = true;
        if (valid) {
          this.$.form._doFakeSubmitForValidation();
        }
        return valid && this.$.form.validate() && this.$.form.checkValidity();
    },

    _save: function(){
      if (!this._validate()) {
          return;
      }
      this.$.dialog.close();
    },*/



    // builds page provider query to get info about downloaded docs
    _downloadsQuery: function(entries) {
      if (entries.length > 0) {
        var values = entries.map(function(entry) {
          return '\'' + entry.key + '\'';
        }).join(',');
        return 'SELECT * FROM Document WHERE ecm:uuid IN (' + values + ')';
      }
    },

    _numberOfDownloads: function(doc) {
      return this.downloads.find(function(entry) {
        return entry.key === doc.uid;
      }).value;
    },

    _range: function(start, end) {
      var res = [];
      for (var i = start; i <= end; i++) {
        res.push(i);
      }
      return res;
    },

    _aggregatePerHourOfDay: function(entries) {
      // aggregate our buckets by key
      var agg = {};
      entries.forEach(function(e) {
        agg[e.key] = agg[e.key] || [];
        agg[e.key].push(e.value);
      });
      // build our total per bucket
      var hours = this._range(this.hoursBounds.min, this.hoursBounds.max);
      return [hours.map(function(i) {
        if (!agg[i] || !agg[i].length) { return 0; }
        // TODO: use Array.reduce once prototype.js is removed!
        // return agg[i].reduce(function(a, b) { return a + b; });
        var sum = 0;
        agg[i].forEach(function(v) { sum += v; });
        return sum;
      })];
    },
    _formatCurrency: function(val) {
      return val.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    },
    _isEmpty: function(items) {
      return items && items.length === 0;
    },

    _toggleReportCreationDialog: function(){
    	this.$.reportCreationDialog.toggle();
    },


    /**
       * Retrieves and creates the layout for the current document type
       */
    _updateDocument: function() {
        /*if (!this._isValidType(this.selectedDocType) || !this.parent) {
          this.document = null;
          return;
        }*/

        this.newDocument(this.selectedDocType, this._getDocumentProperties()).then(function(document) {
          //document.parentRef = this.parent.uid;
          this.document = document;
          this.stage = 'edit';
    	}.bind(this));
    },

    newDocument: function(type, properties) {
      var doc = {
        'entity-type': 'document',
        'type': type,
        'name': '',
        'properties': {
          'dc:title': '',
          'dc:description': ''
        }
      };
      var schemaFetcher = null;
      var schemaRegistry = {};
      // NXP-22300: initialize complex properties
      if (!(type in schemaRegistry)) {
        if (!schemaFetcher) {
          schemaFetcher = document.createElement('nuxeo-resource');
        }
        schemaFetcher.path = '/config/types/' + this.selectedDocType;
        return schemaFetcher.get().then(function(doctype) {
          // cache doctype schemas
          schemaRegistry[doctype.name] = doctype;
          return this._newDocument(doctype, doc, properties);
        }.bind(this));
      } else {
        return Promise.resolve(this._newDocument(schemaRegistry[type], doc, properties));
      }
    },

    _newDocument: function(doctype, doc, properties) {
      if (doctype.schemas) {
        doctype.schemas.forEach(function(schema) {
          this._initializeFields(doc, schema);
        }.bind(this));
      }
      if (properties) {
        for (var prop in properties) {
          doc.properties[prop] = properties[prop];
        }
      }
      return doc;
    },

    _initializeFields: function(doc, node, nodePath) {
      if (typeof nodePath === 'undefined') {
        nodePath = '';
      }
      var prefix = (node['@prefix'] ? node['@prefix'] : node['name']);
      Object.keys(node.fields).forEach(function(fieldName) {
        var field = node.fields[fieldName]
        if (field !== null && typeof field === 'object' &&
            field.type && field.type === 'complex') {
          this._deepFind(doc.properties, nodePath)[prefix + ':' + fieldName] = {};
          this._initializeFields(doc, field, field, nodePath === '' ? fieldName : nodePath + '.' + fieldName);
        }
      }.bind(this));
    },

    _deepFind: function(node, path) {
      return path ? path.split('.').reduce(function(obj,p) { return obj[p]; }, node) : node;
    },




    // extension point
    _getDocumentProperties: function() {
      return null;
    },

    _selectType: function(e) {
        this.selectedDocType = e.model.type;
        this._updateDocument();
        //this.fire('nx-creation-wizard-hide-tabs');
    },

    _validate: function() {
        // run our custom validation function first to allow setting custom native validity
        var valid = this.$['document-create'].validate();

        // fake submit to trigger native validation checks and UI
        if (valid) {
          this.$.form._doFakeSubmitForValidation();
        }

        // XXX: could rely on onsubmit to avoid rechecking for validity
        return this.$.form.validate() && this.$.form.checkValidity() && valid;
      },

      _create: function() {
        if (!this._validate() || !this.canCreate) {
          return;
        }
        this.document.name = this._sanitizeName(this.document.properties['dc:title']);
        this.$.docRequest.post().then(function(response) {
          this.$.creationStats.storeType(this.selectedDocType);
          this._clear();
          this.navigateTo('browse', response.path);
          this._notify(response);
        }.bind(this));
      },

      _back: function() {
        this._clear();
        this.fire('nx-creation-wizard-show-tabs');
      },

      _cancel: function() {
        this._clear();
        this.fire('nx-creation-wizard-show-tabs');
      },

      _newDocumentLabel: function() {
        return this.selectedDocType;
      },

      _clear: function() {
        this.stage = 'choose';
        this.selectedDocType = {};
      },

      _getTypeLabel: function(type) {
        return type? this.i18n('label.document.type.' + type.toLowerCase()):'';
      },

      _getTypeIcon: function(type) {
        return type? 'images/doctypes/' + type.toLowerCase() + '.svg' :'';
      },

  });
  </script>

</dom-module>
