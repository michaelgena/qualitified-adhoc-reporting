<!--
(C) Copyright 2015 Nuxeo SA (http://nuxeo.com/) and others.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.

Contributors:
Gabriel Barata <gbarata@nuxeo.com>
-->
<!--
`nuxeo-home`
@group Nuxeo UI
@element nuxeo-home
-->
<dom-module id="nuxeo-home">
  <template>
    <style>

      .flex-layout {
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: space-between;
      }

      paper-card {
        min-width: 25em;
        width: 49%;
        height: 420px;
      }

      @media (max-width: 1024px) {
        paper-card {
          width: 100%;
        }
      }

      h3 iron-icon {
        width: 1.3em;
        margin-right: 0.4em;
      }

      nuxeo-data-table, nuxeo-tasks-list, nuxeo-tasks-list ::content nuxeo-data-list {
        height: 350px !important;
      }

      .ellipsis {
        text-overflow: ellipsis;
        overflow: hidden;
        white-space: nowrap;
        display: block;
        width: calc(100% - 38px);
      }

      .graph-iron-icon {
        color: #0f9d58;
        --iron-icon-width: 144px;
        --iron-icon-height: 144px;
        margin-top: 50px;
      }

      .graph-flex-layout {
        flex: 1 0 calc(33% - 2em);
        margin: 0 8px 16px;
        text-align: center;
      }

      #button.settings{
        position: absolute;
        top: 8px;
        right: 8px;
      }

      chart-line,
      ::content #canvas.chart-line,
      chart-pie,
      ::content #canvas.chart-pie {
        margin: 25px auto 0 auto;
        width: 100% !important;
        min-width: 30em;
        display: block;
        font-size: .8em;
      }

      #trayReport {
        position: absolute;
        bottom: 32px;
        right: 32px;
        z-index: 10;
      }

      #createReportBtn {
        color: var(--nuxeo-button-primary-text);
        --paper-fab-background: var(--nuxeo-button-primary);
        --paper-fab-keyboard-focus-background: var(--nuxeo-button-primary-focus);
      }
    </style>

    <nuxeo-page>
      <div class="header">[[i18n('home.dashboard')]]</div>
      <div class="content">
        <section name="dashboard" class="flex-layout">

          <nuxeo-repository-data
                                 ecm-primary-type="Opportunity"
                                 ecm-lifecycle-state="new" metrics="sum(opportunity:amount)"
                                 data="{{newAmount}}"
                                 index="[[index]]">
          </nuxeo-repository-data>
          <paper-card class="graph-flex-layout" heading="New Deals" elevation="0" style="width: 33%; height: 210px">
              <h1><strong><span style="font-size: -webkit-xxx-large;">[[_formatCurrency(newAmount)]] €</span></strong></h1>
          </paper-card>


          <nuxeo-repository-data
                                 ecm-primary-type="Opportunity"
                                 ecm-lifecycle-state="ongoing"
                                 metrics="sum(opportunity:amount)"
                                 data="{{ongoingAmount}}"
                                 index="[[index]]">
          </nuxeo-repository-data>
          <paper-card class="graph-flex-layout" heading="Deals in Progress" elevation="0" style="width: 33%; height: 210px">
              <h1><strong><span style="color: #3599DC; font-size: -webkit-xxx-large;">[[_formatCurrency(ongoingAmount)]] €</span></strong></h1>
          </paper-card>


          <nuxeo-repository-data
                                 ecm-primary-type="Opportunity"
                                 ecm-lifecycle-state="won"
                                 metrics="sum(opportunity:amount)"
                                 data="{{wonAmount}}"
                                 index="[[index]]">
          </nuxeo-repository-data>

          <paper-card class="graph-flex-layout" heading="Won Deals" elevation="0" style="width: 33%; height: 210px">
              <h1><strong><span style="color: #43C35E; font-size: -webkit-xxx-large;">[[_formatCurrency(wonAmount)]] €</span></strong></h1>
          </paper-card>


          <!-- Edit graph dynamically -->

          <!-- Number of documents -->
          <nuxeo-repository-data
            ecm-primary-type="[[documentType]]"
            start-date="[[startDate]]"
            end-date="[[_extendEndDate(endDate)]]"
            metrics="cardinality(ecm:uuid)"
            data="{{totalCount}}"
            index="[[index]]">
          </nuxeo-repository-data>
          <paper-card class="graph-flex-layout" heading="{{documentType}}" elevation="0">

            <paper-icon-button class="settings" id="button" icon="icons:settings" on-tap="_toggleGraphDialog"></paper-icon-button>
            <paper-tooltip for="button">Settings</paper-tooltip>

            <iron-icon class="graph-iron-icon" icon="icons:description"></iron-icon>
            <h1>[[totalCount]]</h1>

            <paper-dialog id="dialog" modal on-iron-overlay-closed="_resetPopup" no-auto-focus>
              <!--nuxeo-document id="doc" doc-id="[[document.uid]]"
                          data="{{document}}" response="{{document}}"
                          headers="[[headers]]">
              </nuxeo-document-->
              <h2>Settings</h2>
              <form id="form" is="iron-form">
                <div class="container layout vertical">
                  <div class="row layout horizontal">
                    <div id="document-edit">
                      <paper-input value="{{documentType}}" label="Document Type" type="string" role="widget"></paper-input>
                    </div>
                  </div>
                </div>
                <div class="buttons horizontal end-justified layout">
                  <div class="flex start-justified">
                    <paper-button noink dialog-dismiss>Cancel</paper-button>
                  </div>
                  <paper-button noink class="primary" on-tap="_save">
                    Save
                  </paper-button>
                </div>
              </form>
            </paper-dialog>
          </paper-card>

          <!-- chart-pie -->
          <nuxeo-repository-data start-date="[[startDate]]" end-date="[[endDate]]"
                                 ecm-primary-type="[[documentType]]"
                                 grouped-by="ecm:currentLifeCycleState"
                                 metrics="sum(opportunity:amount)"
                                 data="{{amountCount}}"
                                 index="[[index]]">
          </nuxeo-repository-data>

          <paper-card class="graph-flex-layout" heading="Amount" elevation="0">
            <paper-icon-button class="settings" id="button" icon="icons:settings" on-tap="_toggleGraphDialog"></paper-icon-button>
            <paper-tooltip for="button">Settings</paper-tooltip>
            <div class="card-content">
              <chart-pie values="[[_values(amountCount)]]"
                         labels="[[_labels(amountCount)]]"
                         colors="[[colors]]"
                         options='{ "legend": { "display": true, "position": "bottom", "labels": { "boxWidth": 12 } }, "animation": false }'>
              </chart-pie>
            </div>

            <paper-dialog id="chartDialog" modal on-iron-overlay-closed="_resetPopup" no-auto-focus>
              <!--nuxeo-document id="doc" doc-id="[[document.uid]]"
                          data="{{document}}" response="{{document}}"
                          headers="[[headers]]">
              </nuxeo-document-->
              <h2>Settings</h2>
              <form id="form" is="iron-form">
                <div class="container layout vertical">
                  <div class="row layout horizontal">
                    <div id="document-edit">
                      <paper-input value="{{documentType}}" label="Document Type" type="string" role="widget"></paper-input>
                    </div>
                  </div>
                </div>
                <div class="buttons horizontal end-justified layout">
                  <div class="flex start-justified">
                    <paper-button noink dialog-dismiss>Cancel</paper-button>
                  </div>
                  <paper-button noink class="primary" on-tap="_save">
                    Save
                  </paper-button>
                </div>
              </form>
            </paper-dialog>
          </paper-card>

          <!-- chart-line -->
          <nuxeo-repository-data start-date="[[startDate]]" end-date="[[endDate]]"
                                 ecm-primary-type="[[documentType]]"
                                 with-date-intervals="week"
                                 date-field="dc:created"
                                 data="{{docsCreatedPerWeek}}"
                                 index="[[index]]">
          </nuxeo-repository-data>

          <paper-card heading="{{documentType}}" elevation="0">
            <paper-icon-button class="settings" id="button" icon="icons:settings" on-tap="_toggleGraphDialog"></paper-icon-button>
            <paper-tooltip for="button">Settings</paper-tooltip>
            <div class="card-content">
              <chart-line labels="[[_labels(docsCreatedPerWeek)]]"
                          values="[[_values(docsCreatedPerWeek)]]"
                          options='{ "legend": { "display": false }, "animation": false }'>
              </chart-line>
            </div>
          </paper-card>



          <!-- Top Downloads -->
          <nuxeo-audit-data event-id="download"
                            where='{"extended.downloadReason": "download"}'
                            grouped-by="docUUID"
                            group-limit="10"
                            start-date="[[startDate]]" end-date="[[_extendEndDate(endDate)]]"
                            data="{{downloads}}">
          </nuxeo-audit-data>

          <nuxeo-page-provider auto page-size="10"
            query="[[_downloadsQuery(downloads)]]"
            schemas="dublincore, common"
            current-page="{{downloadedDocs}}">
          </nuxeo-page-provider>

          <paper-card heading="[[i18n('repositoryAnalytics.topDownloads.heading')]]" elevation="0">
            <template is="dom-if" if="[[!_isEmpty(downloads)]]">
              <nuxeo-data-table items="[[downloadedDocs]]">
                <nuxeo-data-table-column name="[[i18n('repositoryAnalytics.topDownloads.file')]]">
                  <template>[[item.title]]</template>
                </nuxeo-data-table-column>
                <nuxeo-data-table-column name="[[i18n('repositoryAnalytics.topDownloads.downloads')]]">
                  <template>[[_numberOfDownloads(item)]]</template>
                </nuxeo-data-table-column>
              </nuxeo-data-table>
            </template>
            <template is="dom-if" if="[[_isEmpty(downloads)]]">
              <div class="message">[[i18n('repositoryAnalytics.noResults')]]</div>
            </template>
          </paper-card>







          <!-- Number of calls per hour -->
          <nuxeo-search-data start-date="[[startDate]]" end-date="[[_extendEndDate(endDate)]]"
                            with-date-intervals="hour"
                            without-extended-bounds
                            date-format="HH"
                            data="{{callsPerHour}}"
                            index="[[index]]">
          </nuxeo-search-data>

          <paper-card heading="[[i18n('searchAnalytics.callsPerHour.heading')]]" elevation="0">
            <chart-bar labels="[[_range(0,23)]]"
                      values="[[_aggregatePerHourOfDay(callsPerHour)]]"
                      series="[[_range(0,23)]]"
                      options='{ "legend": { "display": false }, "animation": false }'>
            </chart-bar>
          </paper-card>







        </section>
      </div>
    </nuxeo-page>


    <div id="trayReport">
      <paper-fab id="createReportBtn" noink="" icon="nuxeo:add" on-tap="_toggleGraphDialog"></paper-fab>
       <paper-tooltip for="createReportBtn" position="left">Create Report</paper-tooltip>
    </div>


  </template>

  <script>
  Polymer({
    is: 'nuxeo-home',
    behaviors: [Nuxeo.RoutingBehavior, Nuxeo.FormatBehavior, Nuxeo.ChartDataBehavior],
    properties: {
      documentType: {
        type: String,
        value: "Opportunity"
      },
      index: {
        type: String,
        value: 'nuxeo'
      },
      startDate: String,
      endDate: String,
      hoursBounds: {
        value: {min: 0, max: 23}
      }
    },

    _navigate: function(e) {
      var detail;
      if (e.detail.item) {
        detail = {
          doc: e.detail.item
        };
        page('/browse' + detail.doc.path);
      } else {
        detail = {
          doc: e.model.item
        };
      }
      this.fire('navigate', detail);
    },

    ready: function() {
      jQuery("#tray").css("display","none");
      /*this._fetchFavorite().then(function(favorite) {
        this.$.favoritesProvider.params = [favorite.uid];
        this.$.favoritesProvider.page = 1;
        this.$.favoritesProvider.fetch();
      }.bind(this));*/
    },

    _fetchFavorite: function() {
      if (this.favorite) {
        return Promise.resolve(this.favorite);
      } else {
        return this.$.fetchFavOp.execute()
          .then(function(resp) {
          this.favorite = resp;
          return resp;
        }.bind(this));
      }
    },

    _toggleGraphDialog: function(){
      this.$.dialog.toggle();
    },

    _validate: function() {
        var valid = true;
        // fake submit to trigger native validation checks and UI
        if (valid) {
          this.$.form._doFakeSubmitForValidation();
        }
        return valid && this.$.form.validate() && this.$.form.checkValidity();
    },

    _save: function(){
      if (!this._validate()) {
          return;
      }
      this.$.dialog.close();
    },



    // builds page provider query to get info about downloaded docs
    _downloadsQuery: function(entries) {
      if (entries.length > 0) {
        var values = entries.map(function(entry) {
          return '\'' + entry.key + '\'';
        }).join(',');
        return 'SELECT * FROM Document WHERE ecm:uuid IN (' + values + ')';
      }
    },

    _numberOfDownloads: function(doc) {
      return this.downloads.find(function(entry) {
        return entry.key === doc.uid;
      }).value;
    },

    _range: function(start, end) {
      var res = [];
      for (var i = start; i <= end; i++) {
        res.push(i);
      }
      return res;
    },

    _aggregatePerHourOfDay: function(entries) {
      // aggregate our buckets by key
      var agg = {};
      entries.forEach(function(e) {
        agg[e.key] = agg[e.key] || [];
        agg[e.key].push(e.value);
      });
      // build our total per bucket
      var hours = this._range(this.hoursBounds.min, this.hoursBounds.max);
      return [hours.map(function(i) {
        if (!agg[i] || !agg[i].length) { return 0; }
        // TODO: use Array.reduce once prototype.js is removed!
        // return agg[i].reduce(function(a, b) { return a + b; });
        var sum = 0;
        agg[i].forEach(function(v) { sum += v; });
        return sum;
      })];
    },
    _formatCurrency: function(val) {
      return val.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }
  });
  </script>

</dom-module>
