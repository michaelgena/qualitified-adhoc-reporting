<!--
  Created by mmakni on 18-12-2018
  mmakni@qualitified.com
-->
<link rel="import" href="reporting-icons.html">
<link rel="import" href="elements/qualitified-dashboard.html">
<link rel="import" href="elements/nuxeo-document-create-popup-modified.html">
<dom-module id="nuxeo-home">
  <template>
    <style include="nuxeo-styles grid-styles">
      .dates {
        @apply --layout-horizontal;
        @apply --layout-center;
        @apply --layout-flex;
        @apply --layout-end-justified;
      }

      nuxeo-date-picker {
        padding: 0 10px;
        margin-top: 5px;
        /*display: inline-flex;*/
      }

      .dashboard {
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: space-between;
      }
      paper-listbox {
        @apply --layout-horizontal;
        --paper-listbox-background-color: transparent;
        padding: 0;
      }

      .toggleBtn {
        padding: 0 0 0 20px;
      }

      .responsibleUser {
        display: inline-flex;
      }

      .report>span {
        visibility: hidden;
        /*visibility: visible;*/
      }

      .report:hover>span {
        visibility: visible;
        color: #c9c9c900;
      }

      #responsibleUser {
        width: 12vw;
      }

      #userWarning {
        color: #fec847;
        margin: auto;
      }

      .userWarningTooltip {
        --paper-tooltip_-_background-color: #fff2d5;
        --paper-tooltip-opacity: 1;
        --paper-tooltip-text-color: #f7bf3a;
        margin: 0px 15px;
      }

      li {
        padding: 2px 0px;
        text-transform: uppercase;
      }

      b {
        line-height: 1.5;
      }

      #tray2 {
        position: fixed;
        bottom: 30px;
        right: 32px;
        z-index: 100;
        background-color: white;
        width: 62px;
        height: 62px;
      }
      #tray1 {
        position: fixed;
        bottom: 30px;
        right: 32px;
        z-index: 100;
        background-color: white;
        width: 62px;
        height: 62px;
      }
    </style>
    <nuxeo-connection id="nxcon" user="{{currentUser}}"></nuxeo-connection>
    <nuxeo-page>

      <div slot="header">

        <!--Dashboard Title-->

        <span class="flex">
          <paper-listbox selected="{{selectedTab}}" attr-for-selected="name">
            <nuxeo-page-item id="dash" name="dashboard" label="home.dashboard"></nuxeo-page-item>
            <nuxeo-page-item id="custom" name="custom" label="home.custom"></nuxeo-page-item>
          </paper-listbox>
        </span>

        <!--Dates-->
        <div class="dates">
          <nuxeo-date-picker value="{{startDate}}" label="[[i18n('analytics.after')]]"></nuxeo-date-picker>
          <nuxeo-date-picker value="{{endDate}}" label="[[i18n('analytics.before')]]"></nuxeo-date-picker>
        </div>

        <!--Responsible User-->
        <div class="responsibleUser">
          <nuxeo-user-suggestion id="responsibleUser"
                                 search-type="USER_TYPE"
                                 label="[[i18n('analytics.responsible.user')]]"
                                 min-chars="0"
                                 params='{"hideThirdLabel": "true"}'
                                 on-value-changed="_userChanged">
          </nuxeo-user-suggestion>

          <paper-icon-button id="userWarning" icon="icons:warning" hidden></paper-icon-button>
          <paper-tooltip for="userWarning" class="userWarningTooltip" animation-delay="0">
            <b>[[i18n('analytics.responsibleUser.warning')]]:</b>
            <ul>
              <template is="dom-repeat" items="{{responsibleUserNotSetDocs}}">
                <li>
                  [[item.title]]
                </li>
              </template>
            </ul>
          </paper-tooltip>
        </div>
        <!--Duplicate Dashboard-->
        <nuxeo-operation id="DuplicateDashboard" op="Qualitified.DuplicateDashboard"></nuxeo-operation>
        <nuxeo-operation id="UndoDashboard" op="Qualitified.UndoDashboard"></nuxeo-operation>
        <nuxeo-operation id="GetUserWorkspace" op="Qualitified.GetUserWorkspace"></nuxeo-operation>
        <div>
          <paper-icon-button noink="" id="duplicateDashButton" on-tap="_duplicateDash" icon="reporting:duplicate" name="browser" role="button" tabindex="1" aria-disabled="false"></paper-icon-button>
          <nuxeo-tooltip>[[i18n('custom.button.duplicate')]]</nuxeo-tooltip>
        </div>


        <div>
          <paper-icon-button noink="" id="undoDashButton" on-tap="_undoDash" icon="reporting:undo" name="browser" role="button" tabindex="2" aria-disabled="false"></paper-icon-button>
          <nuxeo-tooltip>[[i18n('custom.button.undo')]]</nuxeo-tooltip>
        </div>
        <!--nuxeo-filter user="[[currentUser]]" group="administrators">
          <template-->
        <!--Advanced Mode-->
        <!--/template>
      </nuxeo-filter-->
      </div>
      <nuxeo-operation id="getCustomDocs" op="Repository.Query"></nuxeo-operation>

      <iron-pages selected="[[selectedTab]]" attr-for-selected="name" selected-item="{{page}}">
        <div name="dashboard">
          <section name="dashboard" class="dashboard">
            <qualitified-dashboard edit-mode="{{editMode}}" tasks="[[tasks]]" start-date="{{startDate}}"  end-date="{{endDate}}" responsible-user="{{responsibleUser}}" user="Administrator"></qualitified-dashboard>
          </section>
        </div>
        <div name="custom">
          <section name="custom" class="dashboard">
            <qualitified-dashboard edit-mode="{{editMode}}" tasks="[[tasks]]" start-date="{{startDate}}"  end-date="{{endDate}}" responsible-user="{{responsibleUser}}"  user="[[currentUser.id]]"></qualitified-dashboard>
          </section>
        </div>
      </iron-pages>
    </nuxeo-page>


    <div id="tray2" >

    </div>
    <div id="tray1" >
      <paper-fab id="createBtn" noink="" icon="nuxeo:add" on-tap="_openDialog"></paper-fab>
      <paper-tooltip for="createBtn" position="left">[[i18n('documentCreateButton.tooltip')]]</paper-tooltip>
    </div>
    <nuxeo-document id="defaultDoc"
                    auto
                    doc-path="[[userWorkspace]]"
                    enrichers="permissions, subtypes"
                    response="{{parent}}">
    </nuxeo-document>

    <nuxeo-document-create-popup-modified id="importPopup"
                                          parent="[[parent]]"
                                          default-path="[[userWorkspace]]">
    </nuxeo-document-create-popup-modified>
  </template>

  <script>
    Polymer({
      is: 'nuxeo-home',
      behaviors: [Nuxeo.RoutingBehavior, Nuxeo.FormatBehavior, Nuxeo.ChartDataBehavior, Report.DataBehavior, Nuxeo.I18nBehavior],
      properties: {

        startDate: {
          type: String,
          value: ''
        },

        endDate: {
          type: String,
          value: ''
        },
        where: {
          type: String,
        },

        coordinates: {
          type: Array,
          value: {}
        },

        reports: {
          type: Array,
          notify: true,
          value: []
        },

        params: {
          type: Object,
          value: {}
        },

        input: {
          type: Object,
          value: {}
        },

        visible: {
          type: Boolean,
          observer: '_visibleChanged'
        },

        currentUser: {
          type: Object,
          observer:'_currentUserChanged'
        },
         selectedTab: {
          type: Object,
          observer:'_selectedTabChanged'
        }
      },

      _currentUserChanged: function(user){
        if(this.currentUser && this.currentUser.id === "Administrator"){
          this.$.tray2.style="display:none";
        }
       this._checkCustomDash();
      },
      _selectedTabChanged: function(){
       setTimeout(function() {
        document.querySelector("body > nuxeo-app").shadowRoot.querySelector("#pages > nuxeo-home").shadowRoot.querySelector("nuxeo-page > iron-pages > div.iron-selected > section > qualitified-dashboard")._fetch();
      }.bind(this), 1000);
      if(this.currentUser && this.currentUser.id == "Administrator"){
        this.editMode=true;
      }
      else{
        this.editMode= this.currentUser && this.currentUser.id !== "Administrator" && this.selectedTab !=="dashboard";
      }
      },
      _undoDash: function(){
       this.$.UndoDashboard.execute().then(function (resp) {
            this.$.dash.style="display:block";
            this.$.custom.style="display:none";
            this.$.undoDashButton.style="display:none";
            this.$.duplicateDashButton.style="display:block";
            this.selectedTab = "dashboard";
            this.$.tray2.style="display:none";
            document.querySelector("body > nuxeo-app").shadowRoot.querySelector("#pages > nuxeo-home").shadowRoot.querySelector("#dash").click();
            }.bind(this));
      },
      _duplicateDash: function(){
           this.$.custom.style="display:block";
           this.$.undoDashButton.style="display:block";
           this.$.dash.style="display:none";
           this.$.duplicateDashButton.style="display:none";
           this.$.DuplicateDashboard.execute().then(function (resp) {
            this.selectedTab = "custom";
            this.$.tray2.style="display:none";
            document.querySelector("body > nuxeo-app").shadowRoot.querySelector("#pages > nuxeo-home").shadowRoot.querySelector("#custom").click();
            }.bind(this));
      },
      _checkCustomDash: function() {
          if(this.currentUser && this.currentUser.id !== "Administrator"){
          this.$.getCustomDocs.params = {query: `SELECT * FROM Document WHERE ecm:primaryType in ('ChartBar', 'ChartLine', 'ChartPie', 'Count', 'Table', 'List') AND ecm:isTrashed = 0 AND dc:creator ='` + this.currentUser.id + `' AND ecm:currentLifeCycleState != 'deleted' ORDER BY dc:created ASC`};
          this.$.getCustomDocs.set('enrichers', {'document': 'properties'});
          this.$.getCustomDocs.execute().then(function(docs) {
            if (docs && docs.entries && docs.entries.length > 0) {
            this.$.dash.style="display:none";
            this.$.duplicateDashButton.style="display:none";
            this.selectedTab="custom";
            this.$.tray2.style="display:none";
            }else{
            this.$.custom.style="display:none";
            this.$.tray2.style="display:none";
            this.$.undoDashButton.style="display:none";
            document.querySelector("body > nuxeo-app").shadowRoot.querySelector("#pages > nuxeo-home").shadowRoot.querySelector("#dash").click();
            }
          }.bind(this));
          }else{
          this.selectedTab="dashboard";
          this.$.duplicateDashButton.style="display:none";
          this.$.undoDashButton.style="display:none";
          this.$.custom.style="display:none";
          document.querySelector("body > nuxeo-app").shadowRoot.querySelector("#pages > nuxeo-home").shadowRoot.querySelector("#dash").click();
          }
      },
      ready: function () {
        if (moment().format('M') > 6) {
          this.startDate = moment().format('YYYY') + '-07-01';
          this.endDate = moment().format('YYYY') + '-12-31';
        } else {
          this.startDate = moment().format('YYYY') + '-01-01';
          this.endDate = moment().format('YYYY') + '-06-30';
        }
        this.$.GetUserWorkspace.execute().then(function (resp) {
            this.userWorkspace = resp.value;
            }.bind(this));
      },

      _userChanged: function () {
        if (this.$.responsibleUser.value) {
          this.responsibleUser = this.$.responsibleUser.value;
        } else {
          this.responsibleUser = null;
        }
       // this._checkToShowWarning();
      },

      _checkToShowWarning: function () {
        this.responsibleUserNotSetDocs = [];
        this.reportsProvider.forEach(report => {
          if ((report.properties["report:responsibleUser"] == null || report.properties["report:responsibleUser"] == "") && report.type !== "List") {
            this.responsibleUserNotSetDocs.push(report);
          }
        });

        if (this.responsibleUserNotSetDocs && this.responsibleUserNotSetDocs.length > 0 && this.$.responsibleUser.value) {
          this.$.userWarning.hidden = false;
        } else {
          this.$.userWarning.hidden = true;
        }
      },
      _openDialog: function() {
        this.$.importPopup.toggleDialog();


      }

    });
  </script>
</dom-module>
