<!--
@license
(C) Copyright Nuxeo Corp. (http://nuxeo.com/)

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.

 - Created by mmakni on 18-12-2018
-->

<!--
`nuxeo-home`
@group Nuxeo UI
@element nuxeo-home
-->
<link rel="import" href="dist/the-grid.html">
<link rel="import" href="dist/grid-styles.html">
<link rel="import" href="dist/debug-grid.html">

<link rel="import" href="document/chartbar/nuxeo-chartbar-view-layout.html">
<link rel="import" href="document/chartline/nuxeo-chartline-view-layout.html">
<link rel="import" href="document/chartpie/nuxeo-chartpie-view-layout.html">
<link rel="import" href="document/count/nuxeo-count-view-layout.html">
<link rel="import" href="document/table/nuxeo-table-view-layout.html">

<dom-module id="nuxeo-home">
  <template>
    <style include="nuxeo-styles grid-styles">

      .dates {
        @apply --layout-horizontal;
        @apply --layout-center;
        @apply --layout-flex;
        @apply --layout-end-justified;
      }

      .title {
        margin: 0;
        padding: 0px 0px 6px 0px;
        font-size: 30px;
        line-height: 44px;
        letter-spacing: 3px;

      }

      nuxeo-date-picker {
        padding: 0 10px;
        margin-top: 5px;
        /*display: inline-flex;*/
      }

      .toggleBtn {
        padding: 0 0 0 25px;
      }

      .report > span {
        visibility: hidden;
        /*visibility: visible;*/

      }

      .report:hover > span {
        visibility: visible;
        color: #c9c9c900;
      }
    </style>


    <nuxeo-page>


      <div slot="header">

        <!--Dashboard Title-->
        <div class="title"> [[i18n('home.dashboard')]]</div>

        <!--Dates-->
        <div class="dates">
          <nuxeo-date-picker value="{{startDate}}" label="[[i18n('analytics.after')]]"></nuxeo-date-picker>
          <nuxeo-date-picker value="{{endDate}}" label="[[i18n('analytics.before')]]"></nuxeo-date-picker>
        </div>

        <!--Advanced Mode-->
        <div class="toggleBtn">
          <paper-toggle-button id="toggleBtn" on-tap="_switchToEdit"></paper-toggle-button>
          <nuxeo-tooltip>Edit Mode</nuxeo-tooltip>
        </div>

      </div>

      <section name="dashboard" class="dashboard">

        <nuxeo-page-provider  role="widget"
                              auto
                              query="SELECT * FROM Document
                                    WHERE ecm:primaryType in ('ChartBar', 'ChartLine', 'ChartPie', 'Count', 'Table')
                                    AND ecm:isTrashed = 0
                                    AND ecm:currentLifeCycleState != 'deleted'
                                    ORDER BY dc:created ASC"
                              current-page="{{reportsProvider}}">
        </nuxeo-page-provider>

        <nuxeo-operation id="updateOp" op="Document.Update" input="[[input]]" params="[[params]]"></nuxeo-operation>

        <!--debug-grid cell-height="50" cell-width="50" cell-margin="10" col-count="25" row-count="25"></debug-grid-->
        <the-grid id="grid1" draggable resizable row-autogrow col-autogrow cell-height="50" cell-width="50" cell-margin="10" col-count="25" row-count="25">

          <template is="dom-repeat" items="{{reportsProvider}}" as="report">
            <div style="display: none;"> [[_getSavedCoor(report,index)]]</div>

            <template is="dom-if" if="[[isReport(report.type, 'ChartBar',report)]]">
              <nuxeo-chartbar-view-layout class="report"
                                          id$="tile{{index}}"
                                          col$="{{coordinates.col}}"
                                          row$="{{coordinates.row}}"
                                          height$="{{coordinates.height}}"
                                          width$="{{coordinates.width}}"
                                          min-width="3"
                                          min-height="3"
                                          document="[[report]]"
                                          start-date=[[startDate]]
                                          end-date=[[endDate]]
                                          edit-mode=[[editMode]]>
                <span resize="left">│</span>
                <span resize="right">│</span>
                <span resize="top">─</span>
                <span resize="bottom">─</span>
                <span resize="top-right">┐</span>
                <span resize="top-left">┌</span>
                <span resize="bottom-right">┘</span>
                <span resize="bottom-left">└</span>
              </nuxeo-chartbar-view-layout>
            </template>

            <template is="dom-if" if="[[isReport(report.type, 'ChartLine')]]">
              <nuxeo-chartline-view-layout  class="report"
                                            id$="tile{{index}}"
                                            col$="{{coordinates.col}}"
                                            row$="{{coordinates.row}}"
                                            height$="{{coordinates.height}}"
                                            width$="{{coordinates.width}}"
                                            min-width="3"
                                            min-height="3"
                                            document="[[report]]"
                                            start-date=[[startDate]]
                                            end-date=[[endDate]]
                                            edit-mode=[[editMode]]>
                <span resize="left">│</span>
                <span resize="right">│</span>
                <span resize="top">─</span>
                <span resize="bottom">─</span>
                <span resize="top-right">┐</span>
                <span resize="top-left">┌</span>
                <span resize="bottom-right">┘</span>
                <span resize="bottom-left">└</span>
              </nuxeo-chartline-view-layout>

            </template>

            <template is="dom-if" if="[[isReport(report.type, 'ChartPie')]]">
              <nuxeo-chartpie-view-layout class="report"
                                          id$="tile{{index}}"
                                          col$="{{coordinates.col}}"
                                          row$="{{coordinates.row}}"
                                          height$="{{coordinates.height}}"
                                          width$="{{coordinates.width}}"
                                          min-width="3"
                                          min-height="3"
                                          document="[[report]]"
                                          start-date=[[startDate]]
                                          end-date=[[endDate]]
                                          edit-mode=[[editMode]]>
                <span resize="left">│</span>
                <span resize="right">│</span>
                <span resize="top">─</span>
                <span resize="bottom">─</span>
                <span resize="top-right">┐</span>
                <span resize="top-left">┌</span>
                <span resize="bottom-right">┘</span>
                <span resize="bottom-left">└</span>
              </nuxeo-chartpie-view-layout>
            </template>

            <template is="dom-if" if="[[isReport(report.type, 'Count')]]">
              <nuxeo-count-view-layout  class="report"
                                        id$="tile{{index}}"
                                        col$="{{coordinates.col}}"
                                        row$="{{coordinates.row}}"
                                        height$="{{coordinates.height}}"
                                        width$="{{coordinates.width}}"
                                        min-width="3"
                                        min-height="3"
                                        document="[[report]]"
                                        start-date=[[startDate]]
                                        end-date=[[endDate]]
                                        edit-mode=[[editMode]]>
                <span resize="left">│</span>
                <span resize="right">│</span>
                <span resize="top">─</span>
                <span resize="bottom">─</span>
                <span resize="top-right">┐</span>
                <span resize="top-left">┌</span>
                <span resize="bottom-right">┘</span>
                <span resize="bottom-left">└</span>
              </nuxeo-count-view-layout>
            </template>

            <template is="dom-if" if="[[isReport(report.type, 'Table')]]">
              <nuxeo-table-view-layout  class="report"
                                        id$="tile{{index}}"
                                        col$="{{coordinates.col}}"
                                        row$="{{coordinates.row}}"
                                        height$="{{coordinates.height}}"
                                        width$="{{coordinates.width}}"
                                        min-width="3"
                                        min-height="3"
                                        document="[[report]]"
                                        start-date=[[startDate]]
                                        end-date=[[endDate]]
                                        edit-mode=[[editMode]]>
                <span resize="left">│</span>
                <span resize="right">│</span>
                <span resize="top">─</span>
                <span resize="bottom">─</span>
                <span resize="top-right">┐</span>
                <span resize="top-left">┌</span>
                <span resize="bottom-right">┘</span>
                <span resize="bottom-left">└</span>
              </nuxeo-table-view-layout>
            </template>
          </template>

          <div placeholder></div>
        </the-grid>

      </section>
    </nuxeo-page>
  </template>

  <script>
    Polymer({
      is: 'nuxeo-home',
      behaviors: [Nuxeo.RoutingBehavior, Nuxeo.FormatBehavior, Nuxeo.ChartDataBehavior],
      properties: {

        startDate: {
          type: String,
          value: ''
        },

        endDate: {
          type: String,
          value: ''
        },

        editMode: {
          type: Boolean,
          value: true
        },

        coordinates: {
          type: Array,
          value: {}
        },

        reports: {
          type: Array,
          notify: true,
          value: [],
          observer:'_reportsChanged'
        },

        params: {
          type: Object,
          value: {}
        },

        input: {
          type: Object,
          value: {}
        }
      },

      ready: function() {

        if(moment().format('M') > 6){
          this.startDate = moment().format('YYYY')+'-07-01';
          this.endDate = moment().format('YYYY')+'-12-31';
        }else{
          this.startDate = moment().format('YYYY')+'-01-01';
          this.endDate = moment().format('YYYY')+'-06-30';
        }

        /*setTimeout(function() {
          console.log("ready");
          var reportTypes = ['ChartBar', 'ChartLine', 'ChartPie', 'Count', 'Table']
          var nxDocCreate = document.querySelector('nuxeo-app').root.querySelector('nuxeo-document-create-popup').root.querySelector('paper-dialog').querySelector('nuxeo-document-create');
          var createButton = document.querySelector('nuxeo-app').root.querySelector('nuxeo-document-create-popup').root.querySelector('paper-dialog').querySelector('nuxeo-document-create').root.getElementById('create');
          createButton.onclick = function() {
            if(reportTypes.includes(nxDocCreate.selectedDocType.type)){
              //nxDocCreate.navigateTo('home','/');
              //console.log(nxDocCreate.navigateTo('home','/'));
              setTimeout(function() {
                window.location.href = "http://localhost:8080/nuxeo/ui/#!/home";
                console.log(window.location.href);
                console.log("done");
            }, 100);

            }

          };

        }, 3000);*/

        this.$$('#grid1').addEventListener('move', e => {
          this._tileMoved(e);
        });
        this.$$('#grid1').addEventListener('resize', e => {
          this._tileResized(e);
        });
      },

      /* move event when tile is dropped. */
      _tileMoved: function(e) {
        //console.log(e.target);
        var idTile = e.target.getAttribute('id');
        this._getCoor(idTile);
      },

      /* resize event when resizer is dropped. */
      _tileResized: function(e) {
        //console.log(e.target);
        var idTile = e.target.getAttribute('id');
        this._getCoor(idTile);
      },

      isReport: function(type, reportType, report) {
        return type ? type == reportType : false;
      },

      /* Switch to edit mode */
      _switchToEdit: function(e) {
        var btn = this.$.toggleBtn;
        if (btn.checked) {
          this.editMode = false;
        } else {
          this.editMode = true;
        }
      },

      /* Initialize reports: the tile ID and index are the same(id$="tile{{index}}").  reports =[{id,report},...] */
      _getSavedCoor: function(report, index) {
        var savedReport = {};
        savedReport.id = "tile" + index;
        savedReport.report = report;
        this.reports.push(savedReport);
        //console.log(this.reports);
      },

      /*Find an empty player position [The last row on the left] */
      _findPosition: function() {
        var grid = this.$$('#grid1').serialize();
        var maxRow = 0;
        var cors = {};
        for (var i = 0; i < grid.length; i++) {
          if (Number(grid[i].row) > maxRow) {
            maxRow = grid[i].row;
            cors = grid[i];
          }
        }
        cors.col = 0;
        cors.row = Number(cors.row) + Number(cors.height);
        cors.width = 4;
        cors.height = 4;
        return cors;
      },

      /* Initialize the grid. */
      _setCoor: function() {
        //console.log(this.reports.slice());
        for (var i = 0; i < this.reports.length; i++) {
          //console.log(this.reports[i]);
          var tile = this.$$("#" + this.reports[i].id);
          //console.log(tile);

          /* Set coordinates when adding a new report. */
          if (this.reports[i].report.properties['report:col'] == null && this.reports[i].report.properties['report:row'] == null &&
            this.reports[i].report.properties['report:width'] == null && this.reports[i].report.properties['report:height'] == null) {
            var cors = this._findPosition();
            tile.setAttribute('col', cors.col);
            tile.setAttribute('row', cors.row);
            tile.setAttribute('width', cors.width);
            tile.setAttribute('height', cors.height);
            this.reports[i].report.properties['report:col'] = cors.col;
            this.reports[i].report.properties['report:row'] = cors.row;
            this.reports[i].report.properties['report:width'] = cors.width;
            this.reports[i].report.properties['report:height'] = cors.height;
            this.$$("#grid1").ensureSpace(tile); //Increase the grid size if the given tile is out of grid bounds.
          } else {
            /* Set saved coordinates. */
            if(tile){
              tile.setAttribute('col', this.reports[i].report.properties['report:col']);
              tile.setAttribute('row', this.reports[i].report.properties['report:row']);
              tile.setAttribute('width', this.reports[i].report.properties['report:width']);
              tile.setAttribute('height', this.reports[i].report.properties['report:height']);
              this.$$("#grid1").ensureSpace(tile); //Increase the grid size if the given tile is out of grid bounds.
            }
          }
        }
      },

      /* Get and save coordinates when moving or resizing the tile. */
      _getCoor: function(idTile) {
        this.coordinates = this.$$("#grid1").getCoordinates(this.$$("#" + idTile));
        //console.log(this.coordinates);
        //console.log(this.reports);
        //console.log(idTile);
        for (var i = 0; i < this.reports.length; i++) {
          if (this.reports[i].id == idTile) {
            this.input = this.reports[i].report.uid;
            this.reports[i].report.properties['report:col'] = this.coordinates.col;
            this.reports[i].report.properties['report:row'] = this.coordinates.row;
            this.reports[i].report.properties['report:width'] = this.coordinates.width;
            this.reports[i].report.properties['report:height'] = this.coordinates.height;
          }
        }
        /* Update coordinates with new values. */
        this.params = {
          properties: 'report:col =' + this.coordinates.col + '\n' +
            'report:row =' + this.coordinates.row + '\n' +
            'report:width =' + this.coordinates.width + '\n' +
            'report:height =' + this.coordinates.height
        };

        this.$.updateOp.execute().then(function(doc) {
          // console.log('Update: Succes');
        }.bind(this));

        /* Reinitialize the grid with the new coordinates. */
        this._setCoor();
      }
    });
  </script>
</dom-module>
