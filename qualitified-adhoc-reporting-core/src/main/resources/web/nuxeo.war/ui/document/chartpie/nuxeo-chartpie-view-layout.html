<dom-module id="nuxeo-chartpie-view-layout">
  <template>
    <style include="reporting-styles">
      chart-pie {
        width: 100% !important;
        min-width: 30em;
        display: block;
        font-size: .8rem;
        margin-top: 35px;
      }
      .csvAction {
       display: inline-flex;
       position: absolute;
       top: 3px;
       right: 47px;
      }

    </style>

    <nuxeo-repository-data start-date="[[_formatDate(startDate)]]"
                           end-date="[[_extendEndDate(endDate)]]"
                           data="{{data}}"
                           index="[[index]]"
                           ecm-primary-type="[[document.properties.report:primarytype]]"
                           ecm-lifecycle-state="[[document.properties.report:lifeCycleState]]"
                           ecm-mixin-type="[[document.properties.report:mixintype]]"
                           date-field="[[document.properties.report:dateField]]"
                           grouped-by="[[document.properties.report:groupedBy]]"
                           group-limit="[[document.properties.report:groupLimit]]"
                           where="[[_setWhereTerm(document.properties.report:responsibleUser, responsibleUser)]]"
                           metrics="[[document.properties.report:metrics]]">
    </nuxeo-repository-data>

    <nuxeo-card heading="[[document.properties.dc:title]]">
      <div id="edit" hidden$="[[!editMode]]">
        <div class="csvAction">
          <qualitified-export-csv-button id="csvExport" query="[[queryCsvExport]]" schemas="[[_getSchemas(document)]]"></qualitified-export-csv-button>
        </div>
        <report-edit-delete document="{{document}}"></report-edit-delete>
      </div>
      <chart-pie id="chartPie"
                 values="[[_values(data)]]"
                 labels="[[_labels(data)]]"
                 options='{ "legend": { "display": true, "position": "bottom", "labels": { "boxWidth": 12 } }, "animation": false }'>
      </chart-pie>
    </nuxeo-card>
    <slot></slot>
  </template>

  <script>
    Polymer({
      is: 'nuxeo-chartpie-view-layout',
      behaviors: [Nuxeo.LayoutBehavior, Report.DataBehavior],
      properties: {

        /**
           * @doctype ChartPie
           */
        document: {
          type: Object,
        },
        startDate: {
          type: String,
          value: ''
        },
        endDate: {
          type: String,
          value: ''
        },
        data: {
          type: Object,
        },

        queryCsvExport: {
          type: String
        },
        startDate: {
          type: String,
          observer: '_buildCSVQuery'
        },
        endDate: {
          type: String,
          observer: '_buildCSVQuery'
        },
        responsibleUser: {
          type: String,
          value: null,
          observer: '_buildCSVQuery'
        }
      },

      ready: function() {
        this._buildCSVQuery();
      },

      _buildCSVQuery: function(){
        let mixintype= this.document.properties['report:mixintype'] !== null ? " AND ecm:mixintype='"+this.document.properties['report:mixintype']+"'":"";
        let currentLifeCycleState=this.document.properties['report:lifeCycleState'] !== null ? " AND ecm:currentLifeCycleState='"+this.document.properties['report:lifeCycleState']+"'":"";
        let responsibleUser = (this.document.properties['report:responsibleUser'] !== null && this.responsibleUser !== null) ? " AND "+this.document.properties['report:responsibleUser']+"= '"+ this.responsibleUser+"'":"";
        let dateFilter = "";
        if(this.document.properties['report:dateField'] !== null){
          dateFilter = (this.startDate !== null && this.endDate !== null) ? " AND "+this.document.properties['report:dateField']+" BETWEEN DATE '"+this._formatDate(this.startDate)+"' AND DATE '"+this._extendEndDate(this.endDate)+"'" : "";
          if(dateFilter === ""){
            dateFilter = (this.startDate !== null && this.endDate === null) ? " AND "+this.document.properties['report:dateField']+" >= DATE '"+this._formatDate(this.startDate)+"'" : "";
          }
          if(dateFilter === ""){
            dateFilter = (this.startDate === null && this.endDate !== null) ? " AND "+this.document.properties['report:dateField']+" <= DATE '"+this._extendEndDate(this.endDate)+"'" : "";
          }
        }

        this.queryCsvExport = "SELECT * FROM "+this.document.properties['report:primarytype']+
        " WHERE ecm:isProxy = 0 AND ecm:isVersion = 0 AND ecm:isTrashed = 0 "+
        currentLifeCycleState+
        mixintype+
        responsibleUser+
        dateFilter;
      },

      resizeReport: function () {
        this.$.chartPie.resize();
      },

    });
  </script>
</dom-module>
