<!--
`nuxeo-table-view-layout`
@group Nuxeo UI
@element nuxeo-table-view-layout
-->
<link rel="import" href="../../nuxeo-admin/nuxeo-chart-data-behavior.html">
<link rel="import" href="../report-edit-delete.html">

<dom-module id="nuxeo-table-view-layout">
  <template>
    <style>
      *[role=widget] {
        padding: 5px;
      }
      nuxeo-card {
        position: relative;
        margin-bottom: 0;
        width: 100%;
        height: 100%;
      }

      nuxeo-data-table {
        height: 450px;
      }

      #edit{
        height: 0px;
      }
    </style>
    <nuxeo-repository-data start-date="[[startDate]]"
                           end-date="[[_extendEndDate(endDate)]]"
                           data="{{data}}"
                           index="[[index]]"
                           date-field="[[document.properties.report:dateField]]"
                           ecm-primary-type="[[document.properties.report:primarytype]]"
                           ecm-mixin-type="[[document.properties.report:mixintype]]"
                           ecm-lifecycle-state="[[document.properties.report:lifeCycleState]]"
                           grouped-by="[[document.properties.report:groupedBy]]"
                           group-limit="[[document.properties.report:groupLimit]]"
                           metrics="[[document.properties.report:metrics]]">
    </nuxeo-repository-data>

    <!--nuxeo-page-provider auto page-size="10"
                         query="[[_query(data)]]"
                         schemas="*"
                         current-page="{{documents}}">
    </nuxeo-page-provider-->

    <nuxeo-card heading="[[document.properties.dc:title]]">

      <div id="edit" hidden$="[[editMode]]">
        <report-edit-delete document="{{document}}"></report-edit-delete>
      </div>

      <nuxeo-data-table items="[[data]]">

        <nuxeo-data-table-column name="[[document.properties.table:columnName1]]">
          <template>
            <span style$="[[document.properties.table:columnStyle1]]">
              <!--span>
								<iron-icon src="[[_getTypeIcon(item.key)]]"></iron-icon>
							</span-->
              <span>
                [[_labels(item.key)]]
              </span>
            </span>
          </template>
        </nuxeo-data-table-column>

        <nuxeo-data-table-column name="[[document.properties.table:columnName2]]">
          <template>
            <span style$="[[document.properties.table:columnStyle2]]">
              <span>[[document.properties.table:prefix]]</span>
              <span>[[_getValue(item.value)]]</span>
              <span>[[document.properties.table:suffix]]</span>
            </span>
          </template>
        </nuxeo-data-table-column>

      </nuxeo-data-table>

    </nuxeo-card>
    <slot></slot>
  </template>

  <script>
  Polymer({
    is: 'nuxeo-table-view-layout',
    behaviors: [Nuxeo.LayoutBehavior],
    properties: {

      /**
         * @doctype Table
         */
      document: {
        type: Object,
      }
    },

    /*_query: function(entries) {
      if (entries.length > 0) {
        var keys = entries.map(function(entry) {
          return '\'' + entry.key + '\'';
        }).join(','); console.log("keys "+ keys);
        console.log('query SELECT * FROM '+this.document.properties['report:primarytype']+' WHERE ecm:uuid IN (' + keys + ') ORDER BY '+this.document.properties['report:dateField']+' DESC');
        return 'SELECT * FROM '+this.document.properties['report:primarytype']+' WHERE ecm:uuid IN (' + keys + ') ORDER BY '+this.document.properties['report:dateField']+' DESC';
      }
    },*/

    /* _labels Modified*/
    _labels: function(key) {
      var dateFormat = this.document.properties['report:dateFormat'];
      if(dateFormat == "" || dateFormat == null){
        dateFormat = "DD/MM/YYYY";
      }
      if (moment(key).isValid()) {
        return moment(key).format(dateFormat);
      } else {
        return key;
      }
    },

    _extendEndDate: function(date) {
      if (date && moment) {
        return this._formatDate(moment(date).add(1, 'days').subtract(1, 'ms').toJSON());
      }
      return date;
    },

    /* Value Type: Number - Currency */
    _getValue: function(value){
      if(this._isCurrency(this.document)){
        return this._formatCurrency(value);
      }else{
        return value;
      }
    },

    _isCurrency: function(doc){
      return doc? doc.properties['count:valuetype'] == 'Currency' : false;
    },

    _formatCurrency: function(value) {
      return value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    },

    /* Get Icons */
    _getTypeIcon: function(type) {
      return type? ('images/doctypes/' + type.toLowerCase() + '.svg')  : "";
    }

  });
  </script>
</dom-module>
