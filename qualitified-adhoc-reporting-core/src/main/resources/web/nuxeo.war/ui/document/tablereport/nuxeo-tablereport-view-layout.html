<link rel="import" href="nuxeo-tablereport-metadata-layout.html">
<link rel="import" href="nuxeo-tablereport-edit-layout.html">
<dom-module id="nuxeo-tablereport-view-layout">
  <template>
    <style>
      *[role=widget] {
        padding: 5px;
      }
	  paper-card {
        min-width: 25em;
        /*width: 49%;
        height: 420px;*/
      }
      @media (max-width: 1024px) {
        paper-card {
          width: 100%;
        }
      }
      .graph-flex-layout {
        flex: 1 0 calc(33% - 2em);
        margin: 0 8px 16px;
        text-align: center;
      }
      .editor {
        margin: 0 2rem;
        overflow-y: auto;
        padding: 0 1rem 0 0;
      }
      .container {
        overflow: auto;
        flex: 1 1 auto;
        height: 400px;
      }
      #button.settings{
        position: absolute;
        top: 8px;
        right: 8px;
      }
      .line {
        width:100%;
        height:0px;
        border-bottom: 1px solid rgba(179, 172, 172, 0.25);
      }
    </style>
    <nuxeo-repository-data
    	ecm-primary-type="[[document.properties.report:documentType]]"
      ecm-lifecycle-state="[[document.properties.report:lifeCycleState]]"
      metrics="[[document.properties.report:metrics]]"
      grouped-by="[[document.properties.report:groupedBy]]"
      group-limit="[[document.properties.report:groupLimit]]"
      data="{{tableData}}"
      index="[[index]]">
    </nuxeo-repository-data>

    <!-- Top Downloads
    <nuxeo-audit-data event-id="download"
                      where='{"extended.downloadReason": "download"}'
                      grouped-by="docUUID"
                      group-limit="10"
                      start-date="[[startDate]]" end-date="[[_extendEndDate(endDate)]]"
                      data="{{downloads}}">
    </nuxeo-audit-data>
    -->
    <nuxeo-page-provider auto page-size="10"
      query="[[_query(tableData)]]"
      schemas="*"
      current-page="{{documents}}">
    </nuxeo-page-provider>

    <!--nuxeo-search-data start-date="[[startDate]]" end-date="[[_extendEndDate(endDate)]]"
                            with-date-intervals="hour"
                            without-extended-bounds
                            date-format="HH"
                            data="{{callsPerHour}}"
                            index="[[index]]">
          </nuxeo-search-data-->
    <!--nuxeo-audit-data event-id="download"
                            where='{"extended.downloadReason": "download"}'
                            grouped-by="docUUID"
                            group-limit="10"
                            start-date="[[startDate]]" end-date="[[_extendEndDate(endDate)]]"
                            data="{{downloads}}">
          </nuxeo-audit-data-->

    <paper-card class="graph-flex-layout" heading="[[document.properties.dc:title]]" elevation="0" style="width: [[document.properties.report:cardWidth]]%; height: [[document.properties.report:cardHeight]]px">
    	<paper-icon-button class="settings" id="button" icon="icons:settings" on-tap="_toggleGraphDialog"></paper-icon-button>
        <paper-tooltip for="button">Settings</paper-tooltip>

        <template is="dom-if" if="[[!_isEmpty(tableData)]]">
          <template is="dom-if" if="[[!_hasKeyOrValue()]]">
            <template is="dom-repeat" items="[[tableData]]" as="item">
              <p style="clear:both;">
                <span style="[[document.properties.table:keyStyle]]; font-size: larger;float:left;">
          				[[_getLabel(item, 'key')]]
          			</span>
                <span style="[[document.properties.table:valueStyle]]; font-size: x-large;float:right;">
          				<strong>[[_getLabel(item, 'value')]]</strong>
          			</span>
              </p>
              <div class="line"/>
            </template>
          </template>

          <template is="dom-if" if="[[_hasKeyOrValue()]]">
            <template is="dom-repeat" items="[[documents]]" as="item">
              <p style="clear:both;">
                <span style="[[document.properties.table:keyStyle]]; font-size: larger;float:left;">
                  [[_getLabel(item, 'key')]]
                </span>
                <span style="[[document.properties.table:valueStyle]]; font-size: x-large;float:right;">
                  <strong>[[document.properties.table:prefix]] [[_getLabel(item, 'value')]] [[document.properties.table:suffix]]</strong>
                </span>
              </p>
              <div class="line"/>
            </template>
          </template>
        </template>

        <template is="dom-if" if="[[_isEmpty(tableData)]]">
          <div class="message">[[i18n('repositoryAnalytics.noResults')]]</div>
        </template>

      	<paper-dialog id="dialog" modal no-auto-focus>
          <nuxeo-document id="doc" doc-id="[[document.uid]]" response="{{document}}" headers="[[headers]]"></nuxeo-document>
          <nuxeo-operation id="deleteOp" op="Document.Delete" headers="{&quot;nx_es_sync&quot;: &quot;true&quot;}"></nuxeo-operation>
          <div class="horizontal layout heading center">
            <iron-icon src="[[_getTypeIcon(document.type)]]"></iron-icon>
            <span>[[_getTypeLabel(document.type)]]</span>
          </div>
          <iron-pages selected="[[stage]]" attr-for-selected="name" class="vertical layout flex">
            <div name="view" class="vertical layout flex">
              <div class="editor flex container">
                <nuxeo-tablereport-metadata-layout document="[[document]]"></nuxeo-countreport-metadata-layout>
              </div>
              <div class="buttons horizontal end-justified layout">
          		    <div class="flex start-justified">
                  	<paper-button noink="" dialog-dismiss="" on-tap="_cancel">[[i18n('command.cancel')]]</paper-button>
                  </div>
                  <paper-button noink on-tap="_delete">Delete</paper-button>
                  <paper-button noink class="primary" on-tap="_edit">Edit</paper-button>

              </div>
            </div>

            <div name="edit" class="vertical layout flex">
              <form id="form" is="iron-form">
                <div class="editor flex container">
              	   <nuxeo-tablereport-edit-layout document="[[document]]"></nuxeo-countreport-edit-layout>
                </div>
                <div class="buttons horizontal end-justified layout">
                  <div class="flex start-justified">
                    <paper-button noink="" dialog-dismiss="" on-tap="_cancel">[[i18n('command.cancel')]]</paper-button>
                  </div>
                  <paper-button noink class="primary" on-tap="_save">Save</paper-button>
                </div>
              </form>
            </div>

          </iron-pages>
        </paper-dialog>
      </paper-card>
    </template>
  <script>
  (function() {
    'use strict';
    Polymer({
      is: 'nuxeo-tablereport-view-layout',
      behaviors: [Nuxeo.FormatBehavior, Nuxeo.DocumentCreationBehavior],
      properties: {
        /**
           * @doctype Contact
           */
        document: {
          type: Object,
          notify:true,
          observer:'_documentReady'
        },
        params: {
          type: Object,
          value: {},
          notify: true
        },
        stage: {
          type: String,
          value: 'view'
        },
        coordinates:{
          type: Object,
          notify: true
        }
      },
      ready: function() {

      },
      _documentReady: function(){
        this.coordinates = {};
        this.coordinates.uid = this.document.uid;
        this.coordinates.x = this.document.properties['report:x'];
        this.coordinates.y = this.document.properties['report:y'];
        this.coordinates.width = this.document.properties['report:width'];
        this.coordinates.height = this.document.properties['report:height'];
      },
      _getValue: function(val){
      	if(this._isCurrency(this.document)){
      		return this._formatCurrency(val);
      	}else{
      		return val;
      	}
      },
      _isCurrency: function(doc){
      	return doc? doc.properties['count:valueType'] == 'Currency' : false;
      },
      _formatCurrency: function(val) {
      	return val.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
      },
       _toggleGraphDialog: function(){
      	this.$.dialog.toggle();
      },
      _validate: function() {
        var valid = true;
        // fake submit to trigger native validation checks and UI
        if (valid) {
          this.$.form._doFakeSubmitForValidation();
        }
        return valid && this.$.form.validate() && this.$.form.checkValidity();
     },

     _save: function(){
      if (!this._validate()) {
          return;
      }

      this.$.doc.data = {
        'entity-type': 'document',
        uid: this.document.uid,
        properties: this.document.properties
      };

      this.$.doc.put().then(this._refresh.bind(this));
     },

     _refresh: function() {
       this._clear();
       page('/');
       //this.fire('document-updated');
     },

     _clear: function() {
       this.stage = 'view';
       this.$.dialog.close();
     },

     _cancel: function() {
       this._clear();
     },

     _edit: function(){
       this.stage = 'edit';
     },
     _getTypeLabel: function(type) {
       return type? this.i18n('label.document.type.' + type.toLowerCase()):'';
     },

     _getTypeIcon: function(type) {
       return type? 'images/doctypes/' + type.toLowerCase() + '.svg' :'';
     },
     _delete: function(){
       if (confirm(this.i18n('label.delete.report.document')+' '+this.document.title +'?')) {
           this.$.deleteOp.input = 'doc:' + this.document.uid;
           this.$.deleteOp.execute().then(function() {
           this._refresh();
           }.bind(this),
           function(err){
             this._notify(err.response);
             this._clear();
           }.bind(this));
       }
    },
    // builds page provider query to get info about downloaded docs
    _query: function(entries) {
      if (entries.length > 0) {
        var values = entries.map(function(entry) {
          return '\'' + entry.key + '\'';
        }).join(',');
        //console.log('query SELECT * FROM '+this.document.properties['report:primaryType']+' WHERE ecm:uuid IN (' + values + ')');
        return 'SELECT * FROM '+this.document.properties['report:primaryType']+' WHERE ecm:uuid IN (' + values + ') ORDER BY dc:created DESC';
      }
    },
    _isEmpty: function(items) {
      return items && items.length === 0;
    },
    _number: function(doc, documents) {
      return documents.find(function(entry) {
        return entry.key === doc.uid;
      }).value;
    },

    _getLabel: function(item, val){
      if(val == 'key'){
        //console.log(item.properties['dc:title']);
        if(this.document.properties['table:keyMetadata']){
          //console.log('item.properties '+ item.properties[this.document.properties['table:keyMetadata']]);
          return item.properties[this.document.properties['table:keyMetadata']];
        }else{
          return item.key;
        }
      }
      if(val == 'value'){
        let value = "";
        if(this.document.properties['table:valueMetadata']){
          value = item.properties[this.document.properties['table:valueMetadata']];
        }else{
          value = item.value;
        }
        return this._isCurrency(this.document) ? this._formatCurrency(value) : value;
      }
    },
    _hasKeyOrValue: function(){
      return this.document && (this.document.properties['table:keyMetadata'] || this.document.properties['table:valueMetadata']);
    },
    _isCurrency: function(doc){
      return doc? doc.properties['table:valueType'] == 'Currency' : false;
    },
    _formatCurrency: function(val) {
      return val.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }
    });
  })();
  </script>
</dom-module>
