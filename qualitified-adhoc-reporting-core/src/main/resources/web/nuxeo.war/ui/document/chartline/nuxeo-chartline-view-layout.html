<!--
`nuxeo-chartline-view-layout`
@group Nuxeo UI
@element nuxeo-chartline-view-layout
-->
<link rel="import" href="../../nuxeo-admin/nuxeo-chart-data-behavior.html">
<link rel="import" href="../report-edit-delete.html">


<dom-module id="nuxeo-chartline-view-layout">
  <template>
    <style>
      *[role=widget] {
        padding: 5px;
      }

      nuxeo-card {
        position: relative;
        margin-bottom: 0;
        width: 100%;
        height: 100%;
      }

      chart-line{
        width: 100% !important;
        min-width: 30em;
        display: block;
        font-size: .8rem;
      }

      #edit{
        height: 0px;
      }
    </style>

    <nuxeo-repository-data  start-date="[[_formatDate(startDate)]]"
                            end-date="[[_extendEndDate(endDate)]]"
                            data="{{data}}"
                            index="[[index]]"
                            with-date-intervals="[[document.properties.report:withDateIntervals]]"
                            date-field="[[document.properties.report:dateField]]"
                            ecm-primary-type="[[document.properties.report:primarytype]]"
                            ecm-mixin-type="[[document.properties.report:mixintype]]"
                            ecm-lifecycle-state="[[document.properties.report:lifeCycleState]]"
                            metrics="[[document.properties.report:metrics]]">
    </nuxeo-repository-data>

    <nuxeo-card heading="[[document.properties.dc:title]]">
      <div id="edit" hidden$="[[editMode]]">
        <report-edit-delete document="{{document}}"></report-edit-delete>
      </div>
      <chart-line labels="[[_labels(data)]]"
                  values="[[_values(data)]]"
                  options='{ "legend": { "display": false }, "animation": false }'>
      </chart-line>
    </nuxeo-card>
    <slot></slot>
  </template>

  <script>
    Polymer({
      is: 'nuxeo-chartline-view-layout',
      behaviors: [Nuxeo.ChartDataBehavior, Nuxeo.LayoutBehavior],
      properties: {

        /**
         * @doctype ChartLine
         */
        document: {
          type: Object,
        },
        startDate: {
          type: String,
          value: ''
        },
        endDate: {
          type: String,
          value: ''
        }
      },

      /*Check Nuxeo.ChartDataBehavior - Not Working*/
      /* _labels Modified*/
      _labels: function(data) {
        let dateFormat = this.document.properties['report:dateFormat'];
        if (dateFormat == "" || dateFormat == null) {
          dateFormat = "DD/MM/YYYY";
        }
        return data.map(function(entry) {
          if (Array.isArray(entry.value)) {
            return entry.value.map(this._labels.bind(this));
          } else {
            /* Checks if the label is a date metadata otherwise returns the key */
            if (moment(entry.key).isValid()) {
              return moment(entry.key).format(dateFormat);
            } else {
              return entry.key;
            }
          }
        });
      },
      _series: function(data) {
        return data.map(function(obj) {
          return obj.key;
        });
      },
      _values: function(data) {
        return [data.map(function(entry) {
          if (Array.isArray(entry.value)) {
            return entry.value.map(this._values.bind(this));
          } else {
            return entry.value;
          }
        })];
      },
      _extendEndDate: function(date) {
        if (date && moment) {
          return this._formatDate(moment(date).add(1, 'days').subtract(1, 'ms').toJSON());
        }
        return date;
      },

      _formatDate: function(date) {
        return moment(date).format('YYYY-MM-DD');
      }
    });
  </script>
</dom-module>
