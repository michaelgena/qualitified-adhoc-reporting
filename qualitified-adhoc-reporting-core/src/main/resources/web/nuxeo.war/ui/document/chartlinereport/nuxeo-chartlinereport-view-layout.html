<link rel="import" href="nuxeo-chartlinereport-metadata-layout.html">
<link rel="import" href="nuxeo-chartlinereport-edit-layout.html">
<dom-module id="nuxeo-chartlinereport-view-layout">
  <template>
    <style>
      *[role=widget] {
        padding: 5px;
      }
	  paper-card {
        min-width: 25em;
        /*width: 49%;
        height: 420px;*/
        background-color: white;
      }
      @media (max-width: 1024px) {
        paper-card {
          width: 100%;
        }
      }
      .graph-flex-layout {
        flex: 1 0 calc(33% - 2em);
        /*margin: 0 8px 16px;*/
        text-align: center;
      }
      .editor {
        margin: 0 2rem;
        overflow-y: auto;
        padding: 0 1rem 0 0;
      }
      .container {
        overflow: auto;
        flex: 1 1 auto;
        height: 400px;
      }
      #button.settings{
        position: absolute;
        top: 0px;
        right: 0px;
      }

      chart-line,
      ::content #canvas.chart-line,
      chart-pie,
      ::content #canvas.chart-pie {
        margin: 25px auto 0 auto;
        width: 100% !important;
        min-width: 30em;
        display: block;
        font-size: .8em;
      }
    </style>

    <nuxeo-repository-data
                           ecm-primary-type="[[document.properties.report:documentType]]"
                           ecm-lifecycle-state="[[document.properties.report:lifeCycleState]]"
                           with-date-intervals="[[document.properties.report:withDateIntervals]]"
                           date-field="[[document.properties.report:dateField]]"
                           data="{{data}}"
                           index="[[index]]">
    </nuxeo-repository-data>

    <!--`metrics-op` to use as well, ex: `avg(field)` or `min`, `max -->

    <!--nuxeo-search-data start-date="[[startDate]]" end-date="[[_extendEndDate(endDate)]]"
                            with-date-intervals="hour"
                            without-extended-bounds
                            date-format="HH"
                            data="{{callsPerHour}}"
                            index="[[index]]">
          </nuxeo-search-data-->
    <!--nuxeo-audit-data event-id="download"
                            where='{"extended.downloadReason": "download"}'
                            grouped-by="docUUID"
                            group-limit="10"
                            start-date="[[startDate]]" end-date="[[_extendEndDate(endDate)]]"
                            data="{{downloads}}">
          </nuxeo-audit-data-->

    <div class="graph-flex-layout" elevation="0">
      <br/>
      <h3>[[document.properties.dc:title]]</h3>
    	<paper-icon-button class="settings" id="button" icon="icons:settings" on-tap="_toggleGraphDialog"></paper-icon-button>
        <paper-tooltip for="button">Settings</paper-tooltip>
        <div class="card-content">
          <chart-line labels="[[_labels(data)]]"
                      values="[[_values(data)]]"
                      options='[[document.properties.chartline:options]]'>
          </chart-line>
        </div>

      	<paper-dialog id="dialog" modal no-auto-focus>
          <nuxeo-document id="doc" doc-id="[[document.uid]]" response="{{document}}" headers="[[headers]]"></nuxeo-document>
          <nuxeo-operation id="deleteOp" op="Document.Delete" headers="{&quot;nx_es_sync&quot;: &quot;true&quot;}"></nuxeo-operation>
          <div class="horizontal layout heading center">
            <iron-icon src="[[_getTypeIcon(document.type)]]"></iron-icon>
            <span>[[_getTypeLabel(document.type)]]</span>
          </div>
          <iron-pages selected="[[stage]]" attr-for-selected="name" class="vertical layout flex">
            <div name="view" class="vertical layout flex">
              <div class="editor flex container">
                <nuxeo-chartlinereport-metadata-layout document="[[document]]"></nuxeo-chartlinereport-metadata-layout>
              </div>
              <div class="buttons horizontal end-justified layout">
          		    <div class="flex start-justified">
                  	<paper-button noink="" dialog-dismiss="" on-tap="_cancel">[[i18n('command.cancel')]]</paper-button>
                  </div>
                  <paper-button noink on-tap="_delete">Delete</paper-button>
                  <paper-button noink class="primary" on-tap="_edit">Edit</paper-button>

              </div>
            </div>

            <div name="edit" class="vertical layout flex">
              <form id="form" is="iron-form">
                <div class="editor flex container">
              	   <nuxeo-chartlinereport-edit-layout document="[[document]]"></nuxeo-chartlinereport-edit-layout>
                </div>
                <div class="buttons horizontal end-justified layout">
                  <div class="flex start-justified">
                    <paper-button noink="" dialog-dismiss="" on-tap="_cancel">[[i18n('command.cancel')]]</paper-button>
                  </div>
                  <paper-button noink class="primary" on-tap="_save">Save</paper-button>
                </div>
              </form>
            </div>

          </iron-pages>
        </paper-dialog>
      </div>
    </template>
  <script>
  (function() {
    'use strict';
    Polymer({
      is: 'nuxeo-chartlinereport-view-layout',
      behaviors: [Nuxeo.FormatBehavior, Nuxeo.DocumentCreationBehavior, Nuxeo.ChartDataBehavior],
      properties: {
        /**
           * @doctype Contact
           */
        document: {
          type: Object,
          observer:'_documentReady'
        },
        params: {
          type: Object,
          value: {},
          notify: true
        },
        stage: {
            type: String,
            value: 'view'
        },
        coordinates:{
          type: Object,
          notify: true
        },
        isLoaded:{
          type:Boolean,
          notify: true
        }
      },
      ready: function() {
        //this.isLoaded = true;
        this.isLoaded = true;
        //console.log("data "+ data);
      },
      _documentReady: function(){
        if(this.document){
          this.coordinates = {};
          this.coordinates.uid = this.document.uid;
          this.coordinates.x = this.document.properties['report:x'];
          this.coordinates.y = this.document.properties['report:y'];
          this.coordinates.width = this.document.properties['report:width'];
          this.coordinates.height = this.document.properties['report:height'];

          //console.log("is loaded " + this.isLoaded);
        }
      },
      _getValue: function(val){
      	if(this._isCurrency(this.document)){
      		return this._formatCurrency(val);
      	}else{
      		return val;
      	}
      },
      _isCurrency: function(doc){
      	return doc? doc.properties['count:valueType'] == 'Currency' : false;
      },
      _formatCurrency: function(val) {
      	return val.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
      },
       _toggleGraphDialog: function(){
      	this.$.dialog.toggle();
      },
      _validate: function() {
        var valid = true;
        // fake submit to trigger native validation checks and UI
        if (valid) {
          this.$.form._doFakeSubmitForValidation();
        }
        return valid && this.$.form.validate() && this.$.form.checkValidity();
     },

     _save: function(){
      if (!this._validate()) {
          return;
      }

      this.$.doc.data = {
        'entity-type': 'document',
        uid: this.document.uid,
        properties: this.document.properties
      };

      this.$.doc.put().then(this._refresh.bind(this));
     },

     _refresh: function() {
       this._clear();
       page('/');
       //this.fire('document-updated');
     },

     _clear: function() {
       this.stage = 'view';
       this.$.dialog.close();
     },

     _cancel: function() {
       this._clear();
     },

     _edit: function(){
       this.stage = 'edit';
     },
     _getTypeLabel: function(type) {
       return type? this.i18n('label.document.type.' + type.toLowerCase()):'';
     },

     _getTypeIcon: function(type) {
       return type? 'images/doctypes/' + type.toLowerCase() + '.svg' :'';
     },
     _delete: function(){
       if (confirm(this.i18n('label.delete.report.document')+' '+this.document.title +'?')) {
           this.$.deleteOp.input = 'doc:' + this.document.uid;
           this.$.deleteOp.execute().then(function() {
           this._refresh();
           }.bind(this),
           function(err){
             this._notify(err.response);
             this._clear();
           }.bind(this));
       }
    }
    });
  })();
  </script>
</dom-module>
