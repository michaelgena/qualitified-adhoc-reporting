<link rel="import" href="../../elements/qualitified-metadata-selection.html">
<link rel="import" href="../../elements/qualitified-lifecycle-state.html">

<dom-module id="nuxeo-chartbar-create-layout">
  <template>
    <style include="reporting-styles">
      .metricsDiv {
        display: flex;
        /* width: auto; */
        justify-content: space-evenly;
      }
      .dialog {
        margin-top: -19em;
        border-radius: 4px;
        min-width: 400px;
        top: 27em;
      }
      .buttons {
        text-decoration: underline;
        color: blue;
        opacity: 100%;
      }
      .metricsInputDiv {
        display: inline-flex;
        width: -webkit-fill-available;
      }
    </style>
    <nuxeo-resource auto on-response="_handleDocTypes" path="config/types/"></nuxeo-resource>
    <nuxeo-resource auto on-response="_handleFacets" path="config/facets/"></nuxeo-resource>

    <nuxeo-input role="reportWidget" value="{{document.properties.dc:title}}" label="[[i18n('label.dublincore.title')]]" type="text"></nuxeo-input>
    <h3>[[i18n('label.report.layout.dataSettings')]]</h3>
    <label>[[i18n('label.report.documentType')]]</label>
    <nuxeo-selectivity data="[[docTypes]]"
                       min-chars=0
                       multiple
                       placeholder="[[i18n('templateRenderingPage.validDocTypes.placeholder')]]"
                       value="{{selectedDocType}}" ></nuxeo-selectivity>
    <qualitified-lifecycle-state cycle={{cycle}} doctype="{{selectedDocType}}"></qualitified-lifecycle-state>


    <nuxeo-selectivity data="[[facets]]"
                       min-chars=0
                       placeholder=[[i18n('label.report.facet')]]
                       multiple
                       value="{{facet}}" ></nuxeo-selectivity>

    <nuxeo-dialog id="dialog" class="dialog" on-iron-overlay-opened="_open" >
      <div  class="metricsDiv">
        <nuxeo-selectivity data="[[formats]]"
                           min-chars=0
                           placeholder="[[i18n('MetricsType')]]"
                           value="{{agent}}" ></nuxeo-selectivity>
        <qualitified-metadata-selection style="flex:2"  input="{{input}}"></qualitified-metadata-selection>
        <paper-icon-button id="details" noink="" icon="nuxeo:add" on-tap="_addMetricText"></paper-icon-button>
      </div>
      <nuxeo-input id="metricsTest" role="reportWidget" value="{{document.properties.report:metrics}}" label="[[i18n('label.report.metrics')]]" type="text"></nuxeo-input>
      <div class="buttons">
        <paper-button noink dialog-dismiss on-tap="_close">Close</paper-button>
        <paper-button noink  on-tap="_clear">Clear</paper-button>
      </div>
    </nuxeo-dialog>
    <div class="metricsInputDiv">
      <nuxeo-input style="flex: auto;" id="metricsTest" role="reportWidget" value="{{document.properties.report:metrics}}" label="[[i18n('label.report.metrics')]]" type="text"></nuxeo-input>
      <paper-icon-button id="details" noink="" icon="nuxeo:add" role="button" on-tap="_toggleDialog"></paper-icon-button>
    </div>

    <nuxeo-dialog id="dialogGroup" class="dialog" on-iron-overlay-opened="_open" >
      <div  class="metricsDiv">
        <qualitified-metadata-selection style="flex:2"  input="{{input}}"></qualitified-metadata-selection>
        <paper-icon-button id="details" noink="" icon="nuxeo:add" on-tap="_addGroupFieldText"></paper-icon-button>
      </div>
      <nuxeo-input id="groupedByData" role="reportWidget" value="{{document.properties.report:groupedBy}}" label="[[i18n('label.report.groupedBy')]]" type="text"></nuxeo-input>
      <div class="buttons">
        <paper-button noink dialog-dismiss on-tap="_closeGroup">Close</paper-button>
        <paper-button noink  on-tap="_clearGroup">Clear</paper-button>
      </div>
    </nuxeo-dialog>
    <div class="metricsInputDiv">
      <nuxeo-input style="flex: auto;" id="groupedByData" role="reportWidget" value="{{document.properties.report:groupedBy}}" label="[[i18n('label.report.groupedBy')]]" type="text"></nuxeo-input>
      <paper-icon-button id="details" noink="" icon="nuxeo:add" role="button" on-tap="_toggleDialogGroup"></paper-icon-button>
    </div>

    <nuxeo-input role="reportWidget" value="{{document.properties.report:groupLimit}}" label="[[i18n('label.report.groupLimit')]]" type="number"></nuxeo-input>





    <nuxeo-dialog id="dialogDate" class="dialog" on-iron-overlay-opened="_open" >
      <div  class="metricsDiv">
        <qualitified-metadata-selection style="flex:2"  input="{{input}}"></qualitified-metadata-selection>
        <paper-icon-button id="details" noink="" icon="nuxeo:add" on-tap="_addDateFieldText"></paper-icon-button>
      </div>
      <nuxeo-input id="fieldDate" role="reportWidget" value="{{document.properties.report:dateField}}" label="[[i18n('label.report.dateField')]]" type="text"></nuxeo-input>
      <div class="buttons">
        <paper-button noink dialog-dismiss on-tap="_closeDate">Close</paper-button>
        <paper-button noink  on-tap="_clearDate">Clear</paper-button>
      </div>
    </nuxeo-dialog>
    <div class="metricsInputDiv">
      <nuxeo-input style="flex: auto;" id="fieldDate" role="reportWidget" value="{{document.properties.report:dateField}}" label="[[i18n('label.report.dateField')]]" type="text"></nuxeo-input>
      <paper-icon-button id="details" noink="" icon="nuxeo:add" role="button" on-tap="_toggleDialogDate"></paper-icon-button>
    </div>


    <nuxeo-dialog id="dialogKey" class="dialog" on-iron-overlay-opened="_open" >
      <div  class="metricsDiv">
        <qualitified-metadata-selection style="flex:2"  input="{{input}}"></qualitified-metadata-selection>
        <paper-icon-button id="details" noink="" icon="nuxeo:add" on-tap="_addKeyFieldText"></paper-icon-button>
      </div>
      <nuxeo-input id="keyMetadata" role="reportWidget" value="{{document.properties.report:keyMetadata}}" label="[[i18n('label.report.keyMetadata')]]" type="text"></nuxeo-input>
      <div class="buttons">
        <paper-button noink="" dialog-dismiss on-tap="_closekey">Close</paper-button>
        <paper-button noink  on-tap="_clearkey">Clear</paper-button>
      </div>
    </nuxeo-dialog>
    <div class="metricsInputDiv">
      <nuxeo-input style="flex: auto;" id="keyMetadata" role="reportWidget" value="{{document.properties.report:keyMetadata}}" label="[[i18n('label.report.keyMetadata')]]" type="text"></nuxeo-input>
      <paper-icon-button id="details" noink="" icon="nuxeo:add" role="button" on-tap="_toggleDialogKey"></paper-icon-button>
    </div>

    <nuxeo-dialog id="dialogMeta" class="dialog" on-iron-overlay-opened="_open" >
      <div  class="metricsDiv">
        <qualitified-metadata-selection style="flex:2"  input="{{input}}"></qualitified-metadata-selection>
        <paper-icon-button id="details" noink="" icon="nuxeo:add" on-tap="_addMetadataFieldText"></paper-icon-button>
      </div>
      <nuxeo-input id="metaValue" role="reportWidget" value="{{document.properties.report:valueMetadata}}" label="[[i18n('label.report.valueMetadata')]]" type="text"></nuxeo-input>
      <div class="buttons">
        <paper-button noink dialog-dismiss on-tap="_closeMeta">Close</paper-button>
        <paper-button noink  on-tap="_clearMeta">Clear</paper-button>
      </div>
    </nuxeo-dialog>
    <div class="metricsInputDiv">
      <nuxeo-input style="flex: auto;" id="metaValue" role="reportWidget" value="{{document.properties.report:valueMetadata}}" label="[[i18n('label.report.valueMetadata')]]" type="text"></nuxeo-input>
      <paper-icon-button id="details" noink="" icon="nuxeo:add" role="button" on-tap="_toggleDialogMeta"></paper-icon-button>
    </div>

    <nuxeo-directory-suggestion role="reportWidget"
                                value="{{document.properties.report:withDateIntervals}}"
                                label="[[i18n('label.report.datesInterval')]]"
                                directory-name="DateIntervalsType"
                                min-chars="0"
                                dbl10n="true">
    </nuxeo-directory-suggestion>

    <nuxeo-dialog id="dialogUser" class="dialog" on-iron-overlay-opened="_open" >
      <div  class="metricsDiv">
        <qualitified-metadata-selection style="flex:2"  input="{{input}}"></qualitified-metadata-selection>
        <paper-icon-button id="details" noink="" icon="nuxeo:add" on-tap="_addUserFieldText"></paper-icon-button>
      </div>
      <nuxeo-input id="responsibleUser" role="reportWidget" value="{{document.properties.report:responsibleUser}}" label="[[i18n('label.report.responsibleUser')]]" type="text"></nuxeo-input>
      <div class="buttons">
        <paper-button noink dialog-dismiss on-tap="_closeUser">Close</paper-button>
        <paper-button noink  on-tap="_clearUser">Clear</paper-button>
      </div>
    </nuxeo-dialog>
    <div class="metricsInputDiv">
      <nuxeo-input style="flex: auto;" id="responsibleUser" role="reportWidget" value="{{document.properties.report:responsibleUser}}" label="[[i18n('label.report.responsibleUser')]]" type="text"></nuxeo-input>
      <paper-icon-button id="details" noink="" icon="nuxeo:add" role="button" on-tap="_toggleDialogUser"></paper-icon-button>
    </div>


    <h3>[[i18n('label.report.layout.display')]]</h3>

    <nuxeo-input role="reportWidget" value="{{document.properties.report:dateFormat}}" label="[[i18n('label.report.dateFormat')]]" type="text"></nuxeo-input>


    <h3>[[i18n('label.report.layout.csv')]]</h3>
    <nuxeo-input role="reportWidget" value="{{document.properties.report:schemas}}" label="[[i18n('label.report.schemas')]]" type="text"></nuxeo-input>
  </template>

  <script>
    Polymer({
      is: 'nuxeo-chartbar-create-layout',
      behaviors: [Nuxeo.LayoutBehavior],
      properties: {

        /**
         * @doctype ChartBar
         */
        document: {
          type: Object,
          notify:true,
        },
        input: {
          type:String,
          observer: '_inputChanged'
        },
        agent: {
          type:String,
          notify:true,
          observer: '_inputChanged'
        },
        formats:  Array,
        metrics: {
          String,
          notify:true,
          value:"",
        },
        open: {
          type: Boolean,
          value: false
        },
        datefield: {
          String,
          notify:true,
          value:"",
        },
        keyfield: {
          String,
          notify:true,
          value:"",
        },
        userfield: {
          String,
          notify:true,
          value:"",
        },
        groupefield: {
          String,
          notify:true,
          value:"",
        },
        metadatafield: {
          String,
          notify:true,
          value:"",
        },
        params: {
          type: Object,
          value: {}
        },
        docSelection:{
          type: String,
          notify: true,
        },
        selectedDocType:{
                type: String,
                notify: true,
                observer: "_selectedDocTypeChanged"
              },
        cycle: {
          type:String,
          observer: '_inputCycleChanged'
        },
        facet: {
          type:String,
          observer: '_inputFacetChanged'
        },
      },
      ready() {
        this.formats = [
          { id: 'sum', text: 'sum',displayLabel:"sum" },
          { id: 'avg', text: 'avg',displayLabel:"avg" },
          { id: 'max', text: 'max',displayLabel:"max" },
          { id: 'min', text: 'min' ,displayLabel:"min"},
          { id: 'count', text: 'count' ,displayLabel:"count"},
        ];
      },
      _handleDocTypes: function(e) {
        var docTypes = [{
          id: 'all',
          text: this.i18n('templateRenderingPage.label.document.type.all'),
          displayLabel: this.i18n('templateRenderingPage.label.document.type.all')
        }];
        Object.keys(e.detail.response.doctypes).sort().forEach(function(docType) {
          docTypes.push({
            id: docType,
            text: docType,
            displayLabel: docType
          });
        });
        this.set('docTypes', docTypes);
      },
      _handleFacets: function(e) {
        var facets = [{
          id: 'all',
          text: this.i18n('templateRenderingPage.label.document.type.all'),
          displayLabel: this.i18n('templateRenderingPage.label.document.type.all')
        }];
        fetch(window.location.href.split("ui/#!")[0] + 'api/v1/config/facets')
                .then((resp) => resp.json())
                .then(function (data) {
                  const copyItems = [];

                  data.sort().forEach((item) => {
                    copyItems.push(item.name);
                  });
                  copyItems.sort(function (a, b) {
                    return a.localeCompare(b); //using String.prototype.localCompare()
                  });
                  var facets = Array.from(copyItems);
                  this.set('facets', facets);
                }.bind(this));
      },

      _addMetricText :function () {
        var metricsInput = this.$.metricsTest;

        if (metricsInput.value == null) {
          metricsInput.value = this.metrics;
        } else if (metricsInput.value !== null) {
          if (!metricsInput.value.includes(this.metrics)) {
            metricsInput.value += this.metrics;
          }}
      },

      _addDateFieldText :function () {
        var dateInput = this.$.fieldDate;
        this._inputDateChanged();
        if (dateInput.value == null) {
          dateInput.value = this.datefield;
        } else if (dateInput.value !== null) {
          if (!dateInput.value.includes(this.datefield)) {
            dateInput.value += this.datefield;
          }}
      },

      _addKeyFieldText :function () {
        var keyInput = this.$.keyMetadata;
        this._inputKeyChanged();
        if (keyInput.value == null) {
          keyInput.value = this.keyfield;
        } else if (keyInput.value !== null) {
          if (!keyInput.value.includes(this.keyfield)) {
            keyInput.value += this.keyfield;
          }}
      },

      _addMetadataFieldText :function () {
        var keyInput = this.$.metaValue;
        this._inputMetadataChanged();
        if (keyInput.value == null) {
          keyInput.value = this.groupefield;
        } else if (keyInput.value !== null) {
          if (!keyInput.value.includes(this.groupefield)) {
            keyInput.value += this.groupefield;
          }}
      },

      _addUserFieldText :function () {
        var userInput = this.$.responsibleUser;
        this._inputUserChanged();
        if (userInput.value == null) {
          userInput.value = this.userfield;
        } else if (userInput.value !== null) {
          if (!userInput.value.includes(this.userfield)) {
            userInput.value += this.userfield;
          }}
      },
      _addGroupFieldText :function () {
        var userInput = this.$.groupedByData;
        this._inputGroupeChanged();
        if (userInput.value == null) {
          userInput.value = this.groupefield;
        } else if (userInput.value !== null) {
          if (!userInput.value.includes(this.groupefield)) {
            userInput.value += this.groupefield;
          }}
      },
      _inputCycleChanged: function () {
        if (this.cycle ){
          this.set("document.properties.report:lifeCycleState", this.cycle);
        }
      },
      _inputFacetChanged: function () {
        if (this.facet ){
          this.set("document.properties.report:mixintype", this.facet.toString());
        }
      },

      _inputDateChanged: function () {
        if (this.input ){
          this.set("datefield", this.input);
        }
      },

      _inputKeyChanged: function () {
        if (this.input ){
          this.set("keyfield", this.input);
        }
      },
      _inputMetadataChanged: function () {
        if (this.input ){
          this.set("metadatafield", this.input);
        }
      },
      _inputGroupeChanged: function () {
        if (this.input ){
          this.set("groupefield", this.input);
        }
      },

      _inputUserChanged: function () {
        if (this.input ){
          this.set("userfield", this.input);
        }
      },
      _selectedDocTypeChanged: function (selectedDocType) {
        if (selectedDocType){
          this.document.properties["dc:title"] = selectedDocType.toString();
          this.document.properties["report:primarytype"] = selectedDocType.toString();
          //console.log("document after doc selection ",this.document)
        }

      },

      _inputChanged: function () {
        if (this.input && this.agent){
          this.set('metrics', this.agent.concat("(",this.input,")"));
        }
      },

//////////////////  Metrics Dialog ////////////////////////////
      _toggleDialog: function () {
        this.$['dialog'].toggle();
      },
      _close: function () {
        this.$['dialog'].close();
      },
      _clear: function () {
        this.$.metricsTest.value = "";
      },
//////////////////  Date field Dialog ////////////////////////////
      _toggleDialogDate: function () {
        this.$['dialogDate'].toggle();
      },
      _closeDate: function () {
        this.$['dialogDate'].close();
      },
      _clearDate: function () {
        this.$.fieldDate.value = "";
      },

//////////////////  Key metadata Dialog ////////////////////////////

      _toggleDialogKey: function () {
        this.$['dialogKey'].toggle();
      },
      _closeKey: function () {
        this.$['dialogKey'].close();
      },
      _clearKey: function () {
        this.$.keyMetadata.value = "";
      },

//////////////////  Responsible User  Dialog ////////////////////////////
      _toggleDialogUser: function () {
        this.$['dialogUser'].toggle();
      },
      _closeUser: function () {
        this.$['dialogUser'].close();
      },
      _clearUser: function () {
        this.$.responsibleUser.value = "";
      },

      //////////////////   Groupe  Dialog ////////////////////////////
      _toggleDialogGroup: function () {
        this.$['dialogGroup'].toggle();
      },
      _closeGroup: function () {
        this.$['dialogGroup'].close();
      },
      _clearGroup: function () {
        this.$.groupedByData.value = "";
      },
      //////////////////  metadata  field  Dialog ////////////////////////////
      _toggleDialogMeta: function () {
        this.$['dialogMeta'].toggle();
      },
      _closeMeta: function () {
        this.$['dialogMeta'].close();
      },
      _clearMeta: function () {
        this.$.metaValue.value = "";
      },

    });
  </script>
</dom-module>

